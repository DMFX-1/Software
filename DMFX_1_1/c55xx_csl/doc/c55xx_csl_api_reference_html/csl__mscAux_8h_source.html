<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>C55XX CSL LP: csl_mscAux.h Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.7.4 -->
<div id="top">
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">C55XX CSL LP</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="annotated.html"><span>Data&#160;Structures</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
      <li><a href="globals.html"><span>Globals</span></a></li>
    </ul>
  </div>
<div class="header">
  <div class="headertitle">
<div class="title">csl_mscAux.h</div>  </div>
</div>
<div class="contents">
<a href="csl__mscAux_8h.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/* ============================================================================</span>
<a name="l00002"></a>00002 <span class="comment"> * Copyright (c) 2008-2012 Texas Instruments Incorporated.</span>
<a name="l00003"></a>00003 <span class="comment"> * Except for those rights granted to you in your license from TI, all rights</span>
<a name="l00004"></a>00004 <span class="comment"> * reserved.</span>
<a name="l00005"></a>00005 <span class="comment"> *</span>
<a name="l00006"></a>00006 <span class="comment"> * Software License Agreement</span>
<a name="l00007"></a>00007 <span class="comment"> * Texas Instruments (TI) is supplying this software for use solely and</span>
<a name="l00008"></a>00008 <span class="comment"> * exclusively on TI devices. The software is owned by TI and/or its suppliers,</span>
<a name="l00009"></a>00009 <span class="comment"> * and is protected under applicable patent and copyright laws.  You may not</span>
<a name="l00010"></a>00010 <span class="comment"> * combine this software with any open-source software if such combination would</span>
<a name="l00011"></a>00011 <span class="comment"> * cause this software to become subject to any of the license terms applicable</span>
<a name="l00012"></a>00012 <span class="comment"> * to such open source software.</span>
<a name="l00013"></a>00013 <span class="comment"> *</span>
<a name="l00014"></a>00014 <span class="comment"> * THIS SOFTWARE IS PROVIDED &quot;AS IS&quot; AND WITH ALL FAULTS.</span>
<a name="l00015"></a>00015 <span class="comment"> * NO WARRANTIES APPLY TO THIS SOFTWARE, WHETHER EXPRESS, IMPLIED OR STATUTORY.</span>
<a name="l00016"></a>00016 <span class="comment"> * EXAMPLES OF EXCLUDED WARRANTIES ARE IMPLIED WARRANTIES OF MERCHANTABILITY</span>
<a name="l00017"></a>00017 <span class="comment"> * AND FITNESS FOR A PARTICULAR PURPOSE AND WARRANTIES OF NON-INFRINGEMENT,</span>
<a name="l00018"></a>00018 <span class="comment"> * BUT ALL OTHER WARRANTY EXCLUSIONS ALSO APPLY. FURTHERMORE, TI SHALL NOT,</span>
<a name="l00019"></a>00019 <span class="comment"> * UNDER ANY CIRCUMSTANCES, BE LIABLE FOR SPECIAL, INCIDENTAL, CONSEQUENTIAL</span>
<a name="l00020"></a>00020 <span class="comment"> * OR PUNITIVE DAMAGES, FOR ANY REASON WHATSOEVER.</span>
<a name="l00021"></a>00021 <span class="comment"> * ============================================================================</span>
<a name="l00022"></a>00022 <span class="comment"> */</span>
<a name="l00023"></a>00023 
<a name="l00031"></a>00031 <span class="comment">/* ============================================================================</span>
<a name="l00032"></a>00032 <span class="comment"> * Revision History</span>
<a name="l00033"></a>00033 <span class="comment"> * ================</span>
<a name="l00034"></a>00034 <span class="comment"> * 25-Oct-2008 Created</span>
<a name="l00035"></a>00035 <span class="comment"> * 08-May-2009 Modified to fix the string desc ASCII to UNICODE conversion issue</span>
<a name="l00036"></a>00036 <span class="comment"> * 28-May-2009 Modified as per the review comments</span>
<a name="l00037"></a>00037 <span class="comment"> * 13-Aug-2010 CSL v2.10 release</span>
<a name="l00038"></a>00038 <span class="comment"> * 06-Jul-2011 CSL v2.50 release</span>
<a name="l00039"></a>00039 <span class="comment"> * 13-Sep-2012 CSL v3.00 release</span>
<a name="l00040"></a>00040 <span class="comment"> * 20-Dec-2012 CSL v3.01 release</span>
<a name="l00041"></a>00041 <span class="comment"> * ============================================================================</span>
<a name="l00042"></a>00042 <span class="comment"> */</span>
<a name="l00043"></a>00043 
<a name="l00044"></a>00044 <span class="preprocessor">#ifndef _CSL_MSCAUX_H_</span>
<a name="l00045"></a>00045 <span class="preprocessor"></span><span class="preprocessor">#define _CSL_MSCAUX_H_</span>
<a name="l00046"></a>00046 <span class="preprocessor"></span>
<a name="l00047"></a>00047 <span class="preprocessor">#ifdef __cplusplus</span>
<a name="l00048"></a>00048 <span class="preprocessor"></span><span class="keyword">extern</span> <span class="stringliteral">&quot;C&quot;</span> {
<a name="l00049"></a>00049 <span class="preprocessor">#endif</span>
<a name="l00050"></a>00050 <span class="preprocessor"></span>
<a name="l00051"></a>00051 <span class="preprocessor">#include &quot;<a class="code" href="csl__usbAux_8h.html" title="USB MUSB functional layer Auxiliary header file.">csl_usbAux.h</a>&quot;</span>
<a name="l00052"></a>00052 <span class="preprocessor">#include &quot;<a class="code" href="csl__msc_8h.html" title="USB MSC functional layer API header file.">csl_msc.h</a>&quot;</span>
<a name="l00053"></a>00053 
<a name="l00054"></a>00054 <span class="preprocessor">#include &lt;stdio.h&gt;</span>
<a name="l00055"></a>00055 
<a name="l00106"></a>00106 <span class="keyword">static</span> <span class="keyword">inline</span>
<a name="l00107"></a><a class="code" href="group__CSL__MSC__FUNCTION.html#ga9d0453399a7bc52edcd2a51a2af31151">00107</a> <span class="keywordtype">void</span> <a class="code" href="group__CSL__MSC__FUNCTION.html#ga9d0453399a7bc52edcd2a51a2af31151">MSC_SetSenseKeys</a>(Uint16    *senseData,
<a name="l00108"></a>00108                       Uint16    senseKey,
<a name="l00109"></a>00109                       Uint16    addSenseKey)
<a name="l00110"></a>00110 {
<a name="l00111"></a>00111    senseData[<a class="code" href="group__CSL__MSC__SYMBOL.html#ga07a14f8b36054b850a04368b4919795d">CSL_MSC_SSD_2</a>] = senseKey;
<a name="l00112"></a>00112    senseData[<a class="code" href="group__CSL__MSC__SYMBOL.html#ga02dc5319223229c8e09edf25b7f8ece8">CSL_MSC_SSD_7</a>] = addSenseKey;
<a name="l00113"></a>00113 }
<a name="l00114"></a>00114 
<a name="l00158"></a>00158 <span class="keyword">static</span> <span class="keyword">inline</span>
<a name="l00159"></a><a class="code" href="group__CSL__MSC__FUNCTION.html#gaf0cd33f55ed273163c24d04654c7903e">00159</a> CSL_Status <a class="code" href="group__CSL__MSC__FUNCTION.html#gaf0cd33f55ed273163c24d04654c7903e">MSC_HandleStateReset</a>(<a class="code" href="structCSL__MscObject.html" title="MSC Mass Storage Object structure.">CSL_MscObject</a>    *pMscHandle,
<a name="l00160"></a>00160                                 <a class="code" href="structCSL__UsbEpObj.html" title="Data Structure for USB Endpoint Object.">CSL_UsbEpHandle</a>  hUsbOutEp)
<a name="l00161"></a>00161 {
<a name="l00162"></a>00162     CSL_Status    status;
<a name="l00163"></a>00163 
<a name="l00164"></a>00164     status = <a class="code" href="group__CSL__USB__FUNCTION.html#ga5986dca460b9e5de21949bb60df1f045">USB_abortTransaction</a>(hUsbOutEp);
<a name="l00165"></a>00165     status = <a class="code" href="group__CSL__USB__FUNCTION.html#ga0976835f84a5fedd800c643e6c86703e">USB_postTransaction</a>(hUsbOutEp, <a class="code" href="group__CSL__MSC__SYMBOL.html#ga3d71285b7b6a914206765035e746ac88">CSL_MSC_STATE_RESET_DATA_SIZE</a>,
<a name="l00166"></a>00166                                  &amp;pMscHandle-&gt;<a class="code" href="structCSL__MscObject.html#a33a41cf4247cde09062f4c7f7b6814d3" title="Array used to store the elements of CBW.">cbw</a>[0], <a class="code" href="group__CSL__USB__SYMBOL.html#ga7bd2d646e37049bcdf340f27ca927e29" title="USB IO Flags.">CSL_USB_IOFLAG_NONE</a>);
<a name="l00167"></a>00167     pMscHandle-&gt;<a class="code" href="structCSL__MscObject.html#a311709c730906093e0f06e51a4f46c75" title="The State the Class is in.">storageState</a> = <a class="code" href="group__CSL__MSC__SYMBOL.html#gaed7caa7cba07d090a2a8f6bac4ecb385">CSL_MSC_STORAGE_STATE_WAIT_FOR_CBW</a>;
<a name="l00168"></a>00168 
<a name="l00169"></a>00169     <span class="keywordflow">return</span>(status);
<a name="l00170"></a>00170 }
<a name="l00171"></a>00171 
<a name="l00217"></a>00217 <span class="keyword">static</span> <span class="keyword">inline</span>
<a name="l00218"></a><a class="code" href="group__CSL__MSC__FUNCTION.html#gaacd692520e36b003e1c9112192c5c1ce">00218</a> CSL_Status <a class="code" href="group__CSL__MSC__FUNCTION.html#gaacd692520e36b003e1c9112192c5c1ce">MSC_HandleStartStopUnit</a>(<a class="code" href="structCSL__MscObject.html" title="MSC Mass Storage Object structure.">CSL_MscObject</a>    *pMscHandle,
<a name="l00219"></a>00219                                    <a class="code" href="structCSL__UsbEpObj.html" title="Data Structure for USB Endpoint Object.">CSL_UsbEpHandle</a>  hUsbInEp,
<a name="l00220"></a>00220                                    Uint16           lunNum)
<a name="l00221"></a>00221 {
<a name="l00222"></a>00222     <a class="code" href="group__CSL__MSC__ENUM.html#ga48cecebe270a1a79f08a869297decf05" title="This Enum defines the Msc media access status.">CSL_MscMediaStatus</a>    mediaEjectStat;
<a name="l00223"></a>00223     CSL_Status            status;
<a name="l00224"></a>00224     Uint16                loadEject;
<a name="l00225"></a>00225 
<a name="l00226"></a>00226     <span class="keywordflow">if</span> (pMscHandle-&gt;<a class="code" href="structCSL__MscObject.html#aa506ab366c7fc9cd0363c2e0627438d4" title="CBW transfer length.">cbwDataTransferLength</a> != 0)
<a name="l00227"></a>00227     {
<a name="l00228"></a>00228         <span class="comment">/* Stall the end point */</span>
<a name="l00229"></a>00229         pMscHandle-&gt;<a class="code" href="structCSL__MscObject.html#a311709c730906093e0f06e51a4f46c75" title="The State the Class is in.">storageState</a> = <a class="code" href="group__CSL__MSC__SYMBOL.html#gad8d38502cbb73314c7fba3184fb51989">CSL_MSC_STORAGE_STATE_SENDING_STALL</a>;
<a name="l00230"></a>00230         status = <a class="code" href="group__CSL__USB__FUNCTION.html#gaa1befea5ae93ae7079e52df923a54c21">USB_stallEndpt</a>(pMscHandle-&gt;<a class="code" href="structCSL__MscObject.html#a0ebf643bf7cce8ae8ed9d85b0947dcf3" title="Bulk Out Endpoint Object Handle.">bulkOutEpHandle</a>);
<a name="l00231"></a>00231         status = <a class="code" href="group__CSL__USB__FUNCTION.html#gaa1befea5ae93ae7079e52df923a54c21">USB_stallEndpt</a>(pMscHandle-&gt;<a class="code" href="structCSL__MscObject.html#adae9f6d49749941398d987f80a4ff2fb" title="Bulk In Endpoint Object Handle.">bulkInEpHandle</a>);
<a name="l00232"></a>00232 
<a name="l00233"></a>00233 
<a name="l00234"></a>00234         <span class="comment">/* Dummy data transfer to intimate MSC_bulk function */</span>
<a name="l00235"></a>00235         status |= <a class="code" href="group__CSL__USB__FUNCTION.html#ga0976835f84a5fedd800c643e6c86703e">USB_postTransaction</a>(pMscHandle-&gt;<a class="code" href="structCSL__MscObject.html#adae9f6d49749941398d987f80a4ff2fb" title="Bulk In Endpoint Object Handle.">bulkInEpHandle</a>,
<a name="l00236"></a>00236                                      0,
<a name="l00237"></a>00237                                      pMscHandle-&gt;<a class="code" href="structCSL__MscObject.html#aab271fb048e57d4e8dd6116dc7fc6206" title="Data buffer pointer used to transfer data to/from Media/usb.">lbaBuffer</a>,
<a name="l00238"></a>00238                                      <a class="code" href="group__CSL__USB__SYMBOL.html#gaaff45fadbb316cd141ef34a431d2f30b">CSL_USB_IOFLAG_NOT</a>);
<a name="l00239"></a>00239 
<a name="l00240"></a>00240         <span class="keywordflow">return</span>(status);
<a name="l00241"></a>00241     }
<a name="l00242"></a>00242 
<a name="l00243"></a>00243     loadEject = pMscHandle-&gt;<a class="code" href="structCSL__MscObject.html#a33a41cf4247cde09062f4c7f7b6814d3" title="Array used to store the elements of CBW.">cbw</a>[<a class="code" href="group__CSL__MSC__SYMBOL.html#gaaddb6d5e4d1fb122df4acc7c3b9e73ff">CSL_MSC_CBW_9</a>] &gt;&gt; <a class="code" href="group__CSL__MSC__SYMBOL.html#gac63c387b97d17851047edf275a87ff3f">CSL_MSC_8BIT_SHIFT</a>;
<a name="l00244"></a>00244     pMscHandle-&gt;<a class="code" href="structCSL__MscObject.html#abf7ba5452f38545a7e95a7980639bdd5" title="Array used to store the elements of CSW.">csw</a>[<a class="code" href="group__CSL__MSC__SYMBOL.html#ga7d9683c59896b2f3cc94b7d7d0e8989c">CSL_MSC_CSW_6</a>] = <a class="code" href="group__CSL__MSC__SYMBOL.html#gae5caac69e5ad97437dc93eb946bc4f70" title="MSC CSW status macros.">CSL_MSC_CSW_STATUS_COMMAND_PASSED</a>;
<a name="l00245"></a>00245 
<a name="l00246"></a>00246     pMscHandle-&gt;<a class="code" href="structCSL__MscObject.html#a311709c730906093e0f06e51a4f46c75" title="The State the Class is in.">storageState</a> = <a class="code" href="group__CSL__MSC__SYMBOL.html#ga047ba96281d1712fcf0ab9ffa4c2cfd3">CSL_MSC_STORAGE_STATE_SENDING_CSW</a>;
<a name="l00247"></a>00247 
<a name="l00248"></a>00248     <span class="keywordflow">if</span>(loadEject == 0x02) <span class="comment">/* If the Eject Command */</span>
<a name="l00249"></a>00249     {
<a name="l00250"></a>00250         <span class="keywordflow">if</span> (pMscHandle-&gt;<a class="code" href="structCSL__MscObject.html#a32da56160cb70b1ec9669b640b8f0198" title="Data pertaining to Logical Units Supported.">lun</a>[lunNum].<a class="code" href="structCSL__MscLogicalUnit.html#a34039b9d91c078e112ad501663ca5c6c" title="Media State.">mediaState</a> &amp; <a class="code" href="group__CSL__MSC__SYMBOL.html#ga1af061e43d4c1910a9b4b8998085e898">CSL_MSC_MEDIA_LOCKED</a>)
<a name="l00251"></a>00251         {
<a name="l00252"></a>00252             <a class="code" href="group__CSL__MSC__FUNCTION.html#ga9d0453399a7bc52edcd2a51a2af31151">MSC_SetSenseKeys</a>(pMscHandle-&gt;<a class="code" href="structCSL__MscObject.html#a6e3a1597b42e91ccb56d4f26c87fbd0e" title="Sense Data Array.">senseData</a>,
<a name="l00253"></a>00253                 <a class="code" href="group__CSL__MSC__SYMBOL.html#gad88f151f36e35b014a6c099d20320971">CSL_MSC_SCSI_SENSEKEY_UNIT_ATTENTION</a>,
<a name="l00254"></a>00254                 <a class="code" href="group__CSL__MSC__SYMBOL.html#ga5f41436b7748487ba4a735f25edca768">CSL_MSC_SCSI_ASC_MEDIA_REMOVAL_PREVENTED</a>);
<a name="l00255"></a>00255             pMscHandle-&gt;<a class="code" href="structCSL__MscObject.html#abf7ba5452f38545a7e95a7980639bdd5" title="Array used to store the elements of CSW.">csw</a>[<a class="code" href="group__CSL__MSC__SYMBOL.html#ga7d9683c59896b2f3cc94b7d7d0e8989c">CSL_MSC_CSW_6</a>] = <a class="code" href="group__CSL__MSC__SYMBOL.html#gacf6aa3954cb8b1d6fdac285b42a0fe8c">CSL_MSC_CSW_STATUS_COMMAND_FAILED</a>;
<a name="l00256"></a>00256         }
<a name="l00257"></a>00257         <span class="keywordflow">else</span>
<a name="l00258"></a>00258         {
<a name="l00259"></a>00259             mediaEjectStat = pMscHandle-&gt;<a class="code" href="structCSL__MscObject.html#a751f564499ac99abd0b88f831f0b1dc7" title="Function to Eject Media.">mediaEject</a>(lunNum);
<a name="l00260"></a>00260             <span class="keywordflow">if</span> (mediaEjectStat == <a class="code" href="group__CSL__MSC__ENUM.html#gga48cecebe270a1a79f08a869297decf05a342e6b8709b7db64a26895123a0be3d8">CSL_MSC_MEDIACCESS_SUCCESS</a>)
<a name="l00261"></a>00261             {
<a name="l00262"></a>00262                 <span class="comment">/* Change the media state to not present or not bad */</span>
<a name="l00263"></a>00263                 pMscHandle-&gt;<a class="code" href="structCSL__MscObject.html#a32da56160cb70b1ec9669b640b8f0198" title="Data pertaining to Logical Units Supported.">lun</a>[lunNum].<a class="code" href="structCSL__MscLogicalUnit.html#a34039b9d91c078e112ad501663ca5c6c" title="Media State.">mediaState</a> &amp;=~(<a class="code" href="group__CSL__MSC__SYMBOL.html#ga495e0e695499eb196135f1bac670bda4" title="USB MSC media state definitions.">CSL_MSC_MEDIA_PRESENT</a> | <a class="code" href="group__CSL__MSC__SYMBOL.html#ga55e25032ae02dc12ff2ca48bfec7625a">CSL_MSC_MEDIA_BAD</a>);
<a name="l00264"></a>00264                 <a class="code" href="group__CSL__MSC__FUNCTION.html#ga9d0453399a7bc52edcd2a51a2af31151">MSC_SetSenseKeys</a>(pMscHandle-&gt;<a class="code" href="structCSL__MscObject.html#a6e3a1597b42e91ccb56d4f26c87fbd0e" title="Sense Data Array.">senseData</a>,
<a name="l00265"></a>00265                     <a class="code" href="group__CSL__MSC__SYMBOL.html#ga30ee204888259c28c7fd5caabcd8b9c7" title="MSC SCSI sense keys.">CSL_MSC_SCSI_SENSEKEY_NO_SENSE</a>,
<a name="l00266"></a>00266                     <a class="code" href="group__CSL__MSC__SYMBOL.html#gae75c727eda338fd7333f2dd1aa4a91bf" title="MSC SCSI additional sense keys.">CSL_MSC_SCSI_ASC_NO_ADDITIONAL_SENSE_INFORMATION</a>);
<a name="l00267"></a>00267             }
<a name="l00268"></a>00268             <span class="keywordflow">else</span>
<a name="l00269"></a>00269             {
<a name="l00270"></a>00270                 pMscHandle-&gt;<a class="code" href="structCSL__MscObject.html#abf7ba5452f38545a7e95a7980639bdd5" title="Array used to store the elements of CSW.">csw</a>[<a class="code" href="group__CSL__MSC__SYMBOL.html#ga7d9683c59896b2f3cc94b7d7d0e8989c">CSL_MSC_CSW_6</a>] = <a class="code" href="group__CSL__MSC__SYMBOL.html#gacf6aa3954cb8b1d6fdac285b42a0fe8c">CSL_MSC_CSW_STATUS_COMMAND_FAILED</a>;
<a name="l00271"></a>00271                 <a class="code" href="group__CSL__MSC__FUNCTION.html#ga9d0453399a7bc52edcd2a51a2af31151">MSC_SetSenseKeys</a>(pMscHandle-&gt;<a class="code" href="structCSL__MscObject.html#a6e3a1597b42e91ccb56d4f26c87fbd0e" title="Sense Data Array.">senseData</a>,
<a name="l00272"></a>00272                     <a class="code" href="group__CSL__MSC__SYMBOL.html#ga00b282d94fedf1122b535baf75fa778d">CSL_MSC_SCSI_SENSEKEY_ILLEGAL_REQUEST</a>,
<a name="l00273"></a>00273                     <a class="code" href="group__CSL__MSC__SYMBOL.html#gab4fd5af97f69bcbadca04ebbb09eb7b9">CSL_MSC_SCSI_ASC_INVALID_COMMAND_OPERATION_CODE</a>);
<a name="l00274"></a>00274             }
<a name="l00275"></a>00275         }
<a name="l00276"></a>00276     }
<a name="l00277"></a>00277     <span class="keywordflow">else</span>
<a name="l00278"></a>00278     {
<a name="l00279"></a>00279         <a class="code" href="group__CSL__MSC__FUNCTION.html#ga9d0453399a7bc52edcd2a51a2af31151">MSC_SetSenseKeys</a>(pMscHandle-&gt;<a class="code" href="structCSL__MscObject.html#a6e3a1597b42e91ccb56d4f26c87fbd0e" title="Sense Data Array.">senseData</a>,
<a name="l00280"></a>00280             <a class="code" href="group__CSL__MSC__SYMBOL.html#ga30ee204888259c28c7fd5caabcd8b9c7" title="MSC SCSI sense keys.">CSL_MSC_SCSI_SENSEKEY_NO_SENSE</a>,
<a name="l00281"></a>00281             <a class="code" href="group__CSL__MSC__SYMBOL.html#gae75c727eda338fd7333f2dd1aa4a91bf" title="MSC SCSI additional sense keys.">CSL_MSC_SCSI_ASC_NO_ADDITIONAL_SENSE_INFORMATION</a>);
<a name="l00282"></a>00282         <span class="comment">/* Change the media state to not present or not bad .. PRASAD*/</span>
<a name="l00283"></a>00283         pMscHandle-&gt;<a class="code" href="structCSL__MscObject.html#a32da56160cb70b1ec9669b640b8f0198" title="Data pertaining to Logical Units Supported.">lun</a>[lunNum].<a class="code" href="structCSL__MscLogicalUnit.html#a34039b9d91c078e112ad501663ca5c6c" title="Media State.">mediaState</a> &amp;=~(<a class="code" href="group__CSL__MSC__SYMBOL.html#ga495e0e695499eb196135f1bac670bda4" title="USB MSC media state definitions.">CSL_MSC_MEDIA_PRESENT</a> | <a class="code" href="group__CSL__MSC__SYMBOL.html#ga55e25032ae02dc12ff2ca48bfec7625a">CSL_MSC_MEDIA_BAD</a>);
<a name="l00284"></a>00284     }
<a name="l00285"></a>00285 
<a name="l00286"></a>00286     status = <a class="code" href="group__CSL__USB__FUNCTION.html#ga0976835f84a5fedd800c643e6c86703e">USB_postTransaction</a>(hUsbInEp,13,&amp;pMscHandle-&gt;<a class="code" href="structCSL__MscObject.html#abf7ba5452f38545a7e95a7980639bdd5" title="Array used to store the elements of CSW.">csw</a>[0],<a class="code" href="group__CSL__USB__SYMBOL.html#ga7bd2d646e37049bcdf340f27ca927e29" title="USB IO Flags.">CSL_USB_IOFLAG_NONE</a>);
<a name="l00287"></a>00287 
<a name="l00288"></a>00288     <span class="keywordflow">return</span>(status);
<a name="l00289"></a>00289 }
<a name="l00290"></a>00290 
<a name="l00336"></a>00336 <span class="keyword">static</span> <span class="keyword">inline</span>
<a name="l00337"></a><a class="code" href="group__CSL__MSC__FUNCTION.html#gae0cf7468d0df0233275984398dd072f7">00337</a> CSL_Status <a class="code" href="group__CSL__MSC__FUNCTION.html#gae0cf7468d0df0233275984398dd072f7">MSC_HandleStateSendCSW</a>(<a class="code" href="structCSL__MscObject.html" title="MSC Mass Storage Object structure.">CSL_MscObject</a>    *pMscHandle,
<a name="l00338"></a>00338                                   <a class="code" href="structCSL__UsbEpObj.html" title="Data Structure for USB Endpoint Object.">CSL_UsbEpHandle</a>  hUsbOutEp,
<a name="l00339"></a>00339                                   <a class="code" href="structCSL__UsbEpObj.html" title="Data Structure for USB Endpoint Object.">CSL_UsbEpHandle</a>  hUsbInEp)
<a name="l00340"></a>00340 {
<a name="l00341"></a>00341     CSL_Status    status;
<a name="l00342"></a>00342 
<a name="l00343"></a>00343     <span class="keywordflow">if</span>(<a class="code" href="group__CSL__USB__FUNCTION.html#gaa43f74a858cb4c895e146b75cbf44ab9">USB_isTransactionDone</a>(hUsbInEp, &amp;status))
<a name="l00344"></a>00344     {
<a name="l00345"></a>00345         pMscHandle-&gt;<a class="code" href="structCSL__MscObject.html#a78fafcf28c6e0cbf18150a3e4b3d4c22" title="Flag to Indicate whether any Media has been Accessed.">activityPresentFlag</a> = FALSE;
<a name="l00346"></a>00346         pMscHandle-&gt;<a class="code" href="structCSL__MscObject.html#a311709c730906093e0f06e51a4f46c75" title="The State the Class is in.">storageState</a> = <a class="code" href="group__CSL__MSC__SYMBOL.html#gaed7caa7cba07d090a2a8f6bac4ecb385">CSL_MSC_STORAGE_STATE_WAIT_FOR_CBW</a>;
<a name="l00347"></a>00347         status |= <a class="code" href="group__CSL__USB__FUNCTION.html#ga0976835f84a5fedd800c643e6c86703e">USB_postTransaction</a>(hUsbOutEp, <a class="code" href="group__CSL__MSC__SYMBOL.html#ga29b8e226727e410109faeab67bf1155e">CSL_MSC_CBW_DATA_SIZE</a>,
<a name="l00348"></a>00348                                   &amp;pMscHandle-&gt;<a class="code" href="structCSL__MscObject.html#a33a41cf4247cde09062f4c7f7b6814d3" title="Array used to store the elements of CBW.">cbw</a>[0], <a class="code" href="group__CSL__USB__SYMBOL.html#ga7bd2d646e37049bcdf340f27ca927e29" title="USB IO Flags.">CSL_USB_IOFLAG_NONE</a>);
<a name="l00349"></a>00349     }
<a name="l00350"></a>00350 
<a name="l00351"></a>00351     <span class="keywordflow">return</span>(status);
<a name="l00352"></a>00352 }
<a name="l00353"></a>00353 
<a name="l00398"></a>00398 <span class="keyword">static</span> <span class="keyword">inline</span>
<a name="l00399"></a><a class="code" href="group__CSL__MSC__FUNCTION.html#ga365f33f75e7ded19a489336acf61bd1b">00399</a> CSL_Status <a class="code" href="group__CSL__MSC__FUNCTION.html#ga365f33f75e7ded19a489336acf61bd1b">MSC_HandleStateSendData</a>(<a class="code" href="structCSL__MscObject.html" title="MSC Mass Storage Object structure.">CSL_MscObject</a>    *pMscHandle,
<a name="l00400"></a>00400                                    <a class="code" href="structCSL__UsbEpObj.html" title="Data Structure for USB Endpoint Object.">CSL_UsbEpHandle</a>  hUsbInEp)
<a name="l00401"></a>00401 {
<a name="l00402"></a>00402     CSL_Status    status;
<a name="l00403"></a>00403 
<a name="l00404"></a>00404     <span class="keywordflow">if</span>(<a class="code" href="group__CSL__USB__FUNCTION.html#gaa43f74a858cb4c895e146b75cbf44ab9">USB_isTransactionDone</a>(hUsbInEp, &amp;status))
<a name="l00405"></a>00405     {
<a name="l00406"></a>00406         status |= <a class="code" href="group__CSL__USB__FUNCTION.html#ga0976835f84a5fedd800c643e6c86703e">USB_postTransaction</a>(hUsbInEp, <a class="code" href="group__CSL__MSC__SYMBOL.html#ga1cd8224df387eedf86e95e1019454d89">CSL_MSC_CSW_DATA_SIZE</a>,
<a name="l00407"></a>00407                                     &amp;pMscHandle-&gt;<a class="code" href="structCSL__MscObject.html#abf7ba5452f38545a7e95a7980639bdd5" title="Array used to store the elements of CSW.">csw</a>[0], <a class="code" href="group__CSL__USB__SYMBOL.html#ga7bd2d646e37049bcdf340f27ca927e29" title="USB IO Flags.">CSL_USB_IOFLAG_NONE</a>);
<a name="l00408"></a>00408         pMscHandle-&gt;<a class="code" href="structCSL__MscObject.html#a311709c730906093e0f06e51a4f46c75" title="The State the Class is in.">storageState</a> = <a class="code" href="group__CSL__MSC__SYMBOL.html#ga047ba96281d1712fcf0ab9ffa4c2cfd3">CSL_MSC_STORAGE_STATE_SENDING_CSW</a>;
<a name="l00409"></a>00409     }
<a name="l00410"></a>00410 
<a name="l00411"></a>00411     <span class="keywordflow">return</span>(status);
<a name="l00412"></a>00412 }
<a name="l00413"></a>00413 
<a name="l00458"></a>00458 <span class="keyword">static</span> <span class="keyword">inline</span>
<a name="l00459"></a><a class="code" href="group__CSL__MSC__FUNCTION.html#gac6f1b38df1c546ae0f9bbb82e5029b81">00459</a> CSL_Status <a class="code" href="group__CSL__MSC__FUNCTION.html#gac6f1b38df1c546ae0f9bbb82e5029b81">MSC_HandleStateSendStall</a>(<a class="code" href="structCSL__MscObject.html" title="MSC Mass Storage Object structure.">CSL_MscObject</a>    *pMscHandle,
<a name="l00460"></a>00460                                     <a class="code" href="structCSL__UsbEpObj.html" title="Data Structure for USB Endpoint Object.">CSL_UsbEpHandle</a>  hUsbInEp)
<a name="l00461"></a>00461 {
<a name="l00462"></a>00462     CSL_Status    status;
<a name="l00463"></a>00463 
<a name="l00464"></a>00464     <span class="keywordflow">if</span>(<a class="code" href="group__CSL__USB__FUNCTION.html#gaa43f74a858cb4c895e146b75cbf44ab9">USB_isTransactionDone</a>(hUsbInEp, &amp;status))
<a name="l00465"></a>00465     {
<a name="l00466"></a>00466         status |= <a class="code" href="group__CSL__USB__FUNCTION.html#ga0976835f84a5fedd800c643e6c86703e">USB_postTransaction</a>(hUsbInEp, <a class="code" href="group__CSL__MSC__SYMBOL.html#ga1cd8224df387eedf86e95e1019454d89">CSL_MSC_CSW_DATA_SIZE</a>,
<a name="l00467"></a>00467                                      &amp;pMscHandle-&gt;<a class="code" href="structCSL__MscObject.html#abf7ba5452f38545a7e95a7980639bdd5" title="Array used to store the elements of CSW.">csw</a>[0], <a class="code" href="group__CSL__USB__SYMBOL.html#ga7bd2d646e37049bcdf340f27ca927e29" title="USB IO Flags.">CSL_USB_IOFLAG_NONE</a>);
<a name="l00468"></a>00468         pMscHandle-&gt;<a class="code" href="structCSL__MscObject.html#a311709c730906093e0f06e51a4f46c75" title="The State the Class is in.">storageState</a> = <a class="code" href="group__CSL__MSC__SYMBOL.html#ga047ba96281d1712fcf0ab9ffa4c2cfd3">CSL_MSC_STORAGE_STATE_SENDING_CSW</a>;
<a name="l00469"></a>00469     }
<a name="l00470"></a>00470 
<a name="l00471"></a>00471     <span class="keywordflow">return</span>(status);
<a name="l00472"></a>00472 }
<a name="l00473"></a>00473 
<a name="l00518"></a>00518 <span class="keyword">static</span> <span class="keyword">inline</span>
<a name="l00519"></a><a class="code" href="group__CSL__MSC__FUNCTION.html#ga7811b0cc7a5140164839fab44a3b932c">00519</a> CSL_Status <a class="code" href="group__CSL__MSC__FUNCTION.html#ga7811b0cc7a5140164839fab44a3b932c">MSC_HandleStateSendingShortPkt</a>(<a class="code" href="structCSL__MscObject.html" title="MSC Mass Storage Object structure.">CSL_MscObject</a>    *pMscHandle,
<a name="l00520"></a>00520                                           <a class="code" href="structCSL__UsbEpObj.html" title="Data Structure for USB Endpoint Object.">CSL_UsbEpHandle</a>  hUsbInEp)
<a name="l00521"></a>00521 {
<a name="l00522"></a>00522     CSL_Status    status;
<a name="l00523"></a>00523 
<a name="l00524"></a>00524     pMscHandle-&gt;<a class="code" href="structCSL__MscObject.html#a311709c730906093e0f06e51a4f46c75" title="The State the Class is in.">storageState</a> = <a class="code" href="group__CSL__MSC__SYMBOL.html#gad8d38502cbb73314c7fba3184fb51989">CSL_MSC_STORAGE_STATE_SENDING_STALL</a>;
<a name="l00525"></a>00525 
<a name="l00526"></a>00526     status = <a class="code" href="group__CSL__USB__FUNCTION.html#gaa1befea5ae93ae7079e52df923a54c21">USB_stallEndpt</a>(hUsbInEp);
<a name="l00527"></a>00527 
<a name="l00528"></a>00528     <span class="comment">/* Dummy data transfer to intimate MSC_bulk function */</span>
<a name="l00529"></a>00529     status |= <a class="code" href="group__CSL__USB__FUNCTION.html#ga0976835f84a5fedd800c643e6c86703e">USB_postTransaction</a>(hUsbInEp, 0,
<a name="l00530"></a>00530                                   &amp;pMscHandle-&gt;<a class="code" href="structCSL__MscObject.html#abf7ba5452f38545a7e95a7980639bdd5" title="Array used to store the elements of CSW.">csw</a>[0],
<a name="l00531"></a>00531                                   <a class="code" href="group__CSL__USB__SYMBOL.html#gaaff45fadbb316cd141ef34a431d2f30b">CSL_USB_IOFLAG_NOT</a>);
<a name="l00532"></a>00532 
<a name="l00533"></a>00533     <span class="keywordflow">return</span> (status);
<a name="l00534"></a>00534 }
<a name="l00535"></a>00535 
<a name="l00581"></a>00581 <span class="keyword">static</span> <span class="keyword">inline</span>
<a name="l00582"></a><a class="code" href="group__CSL__MSC__FUNCTION.html#ga5bc3c80b4b8d4dc90dfaa9901d00ac80">00582</a> CSL_Status <a class="code" href="group__CSL__MSC__FUNCTION.html#ga5bc3c80b4b8d4dc90dfaa9901d00ac80">MSC_HandleModeSense6</a>(<a class="code" href="structCSL__MscObject.html" title="MSC Mass Storage Object structure.">CSL_MscObject</a>    *pMscHandle,
<a name="l00583"></a>00583                                 <a class="code" href="structCSL__UsbEpObj.html" title="Data Structure for USB Endpoint Object.">CSL_UsbEpHandle</a>  hUsbInEp,
<a name="l00584"></a>00584                                 Uint16           logicalUnit)
<a name="l00585"></a>00585 {
<a name="l00586"></a>00586     CSL_Status    status;
<a name="l00587"></a>00587     Uint16        modeSenseLen;
<a name="l00588"></a>00588     Uint16        smallerLen;
<a name="l00589"></a>00589 
<a name="l00590"></a>00590     <span class="comment">/* Check whether the data direction is proper or not */</span>
<a name="l00591"></a>00591     <span class="keywordflow">if</span>(((pMscHandle-&gt;<a class="code" href="structCSL__MscObject.html#a33a41cf4247cde09062f4c7f7b6814d3" title="Array used to store the elements of CBW.">cbw</a>[<a class="code" href="group__CSL__MSC__SYMBOL.html#gaf7dfe9ecfa4575b0ec4893220879560a">CSL_MSC_CBW_6</a>] &amp;
<a name="l00592"></a>00592          <a class="code" href="group__CSL__MSC__SYMBOL.html#ga72c7914c91fc0889f7dcbeb9600ca1e3">CSL_MSC_CBW_DIRBIT_MASK</a>) != <a class="code" href="group__CSL__MSC__SYMBOL.html#gac6640009ff518fbfcc735c3b3b8255b8">CSL_MSC_CBW_DATADIR_IN</a>) &amp;&amp;
<a name="l00593"></a>00593         (pMscHandle-&gt;<a class="code" href="structCSL__MscObject.html#aa506ab366c7fc9cd0363c2e0627438d4" title="CBW transfer length.">cbwDataTransferLength</a> != 0))
<a name="l00594"></a>00594     {
<a name="l00595"></a>00595         pMscHandle-&gt;<a class="code" href="structCSL__MscObject.html#abf7ba5452f38545a7e95a7980639bdd5" title="Array used to store the elements of CSW.">csw</a>[<a class="code" href="group__CSL__MSC__SYMBOL.html#ga7d9683c59896b2f3cc94b7d7d0e8989c">CSL_MSC_CSW_6</a>] = <a class="code" href="group__CSL__MSC__SYMBOL.html#gaf58418c4b1da667bd6e1ed1ace4abc61">CSL_MSC_CSW_STATUS_PHASE_ERROR</a>;
<a name="l00596"></a>00596 
<a name="l00597"></a>00597         <span class="comment">/* Stall the end point */</span>
<a name="l00598"></a>00598         pMscHandle-&gt;<a class="code" href="structCSL__MscObject.html#a311709c730906093e0f06e51a4f46c75" title="The State the Class is in.">storageState</a> = <a class="code" href="group__CSL__MSC__SYMBOL.html#gad8d38502cbb73314c7fba3184fb51989">CSL_MSC_STORAGE_STATE_SENDING_STALL</a>;
<a name="l00599"></a>00599         status = <a class="code" href="group__CSL__USB__FUNCTION.html#gaa1befea5ae93ae7079e52df923a54c21">USB_stallEndpt</a>(pMscHandle-&gt;<a class="code" href="structCSL__MscObject.html#adae9f6d49749941398d987f80a4ff2fb" title="Bulk In Endpoint Object Handle.">bulkInEpHandle</a>);
<a name="l00600"></a>00600         status = <a class="code" href="group__CSL__USB__FUNCTION.html#gaa1befea5ae93ae7079e52df923a54c21">USB_stallEndpt</a>(pMscHandle-&gt;<a class="code" href="structCSL__MscObject.html#a0ebf643bf7cce8ae8ed9d85b0947dcf3" title="Bulk Out Endpoint Object Handle.">bulkOutEpHandle</a>);
<a name="l00601"></a>00601 
<a name="l00602"></a>00602         <span class="comment">/* Dummy data transfer to intimate MSC_bulk function */</span>
<a name="l00603"></a>00603         status = <a class="code" href="group__CSL__USB__FUNCTION.html#ga0976835f84a5fedd800c643e6c86703e">USB_postTransaction</a>(pMscHandle-&gt;<a class="code" href="structCSL__MscObject.html#adae9f6d49749941398d987f80a4ff2fb" title="Bulk In Endpoint Object Handle.">bulkInEpHandle</a>,
<a name="l00604"></a>00604                                      0,
<a name="l00605"></a>00605                                      pMscHandle-&gt;<a class="code" href="structCSL__MscObject.html#aab271fb048e57d4e8dd6116dc7fc6206" title="Data buffer pointer used to transfer data to/from Media/usb.">lbaBuffer</a>,
<a name="l00606"></a>00606                                      <a class="code" href="group__CSL__USB__SYMBOL.html#gaaff45fadbb316cd141ef34a431d2f30b">CSL_USB_IOFLAG_NOT</a>);
<a name="l00607"></a>00607         <span class="keywordflow">return</span>(status);
<a name="l00608"></a>00608     }
<a name="l00609"></a>00609 
<a name="l00610"></a>00610     <span class="keywordflow">if</span> (pMscHandle-&gt;<a class="code" href="structCSL__MscObject.html#aa506ab366c7fc9cd0363c2e0627438d4" title="CBW transfer length.">cbwDataTransferLength</a> &gt; 0)
<a name="l00611"></a>00611     {
<a name="l00612"></a>00612         modeSenseLen = pMscHandle-&gt;<a class="code" href="structCSL__MscObject.html#a8a314e64cbbd701737419e82c9b3ffcf" title="Buffer to hold Mode Sense request data.">modeSenseData</a>[0];
<a name="l00613"></a>00613 
<a name="l00614"></a>00614         <span class="comment">/* Getting smaller of the two values */</span>
<a name="l00615"></a>00615         <span class="keywordflow">if</span>(modeSenseLen &lt; pMscHandle-&gt;cbwDataTransferLength)
<a name="l00616"></a>00616         {
<a name="l00617"></a>00617             smallerLen = modeSenseLen;
<a name="l00618"></a>00618         }
<a name="l00619"></a>00619         <span class="keywordflow">else</span>
<a name="l00620"></a>00620         {
<a name="l00621"></a>00621             smallerLen = (Uint16)(pMscHandle-&gt;<a class="code" href="structCSL__MscObject.html#aa506ab366c7fc9cd0363c2e0627438d4" title="CBW transfer length.">cbwDataTransferLength</a> &amp;
<a name="l00622"></a>00622                                   <a class="code" href="group__CSL__MSC__SYMBOL.html#gac7d2c8e5f03a1b00a8837ec4a5481a12">CSL_MSC_16BIT_MASK</a>);
<a name="l00623"></a>00623         }
<a name="l00624"></a>00624 
<a name="l00625"></a>00625         <span class="comment">/* Setting the Data Residue :- Transfer Length - Data transferred */</span>
<a name="l00626"></a>00626         pMscHandle-&gt;<a class="code" href="structCSL__MscObject.html#aa506ab366c7fc9cd0363c2e0627438d4" title="CBW transfer length.">cbwDataTransferLength</a> -= (Uint32)smallerLen;
<a name="l00627"></a>00627         pMscHandle-&gt;<a class="code" href="structCSL__MscObject.html#abf7ba5452f38545a7e95a7980639bdd5" title="Array used to store the elements of CSW.">csw</a>[<a class="code" href="group__CSL__MSC__SYMBOL.html#ga70cb0da786d81c97d7bddd7954742bb1">CSL_MSC_CSW_4</a>] =
<a name="l00628"></a>00628               (Uint16)(pMscHandle-&gt;<a class="code" href="structCSL__MscObject.html#aa506ab366c7fc9cd0363c2e0627438d4" title="CBW transfer length.">cbwDataTransferLength</a> &amp; <a class="code" href="group__CSL__MSC__SYMBOL.html#gac7d2c8e5f03a1b00a8837ec4a5481a12">CSL_MSC_16BIT_MASK</a>);
<a name="l00629"></a>00629         pMscHandle-&gt;<a class="code" href="structCSL__MscObject.html#abf7ba5452f38545a7e95a7980639bdd5" title="Array used to store the elements of CSW.">csw</a>[<a class="code" href="group__CSL__MSC__SYMBOL.html#ga07a9acde81eb85d772a92bfe139accfb">CSL_MSC_CSW_5</a>] =
<a name="l00630"></a>00630               (Uint16)(pMscHandle-&gt;<a class="code" href="structCSL__MscObject.html#aa506ab366c7fc9cd0363c2e0627438d4" title="CBW transfer length.">cbwDataTransferLength</a> &gt;&gt; <a class="code" href="group__CSL__MSC__SYMBOL.html#ga7ffd8a4483cfb8e4791575e212fa3adb">CSL_MSC_16BIT_SHIFT</a>);
<a name="l00631"></a>00631         pMscHandle-&gt;<a class="code" href="structCSL__MscObject.html#abf7ba5452f38545a7e95a7980639bdd5" title="Array used to store the elements of CSW.">csw</a>[<a class="code" href="group__CSL__MSC__SYMBOL.html#ga7d9683c59896b2f3cc94b7d7d0e8989c">CSL_MSC_CSW_6</a>] = <a class="code" href="group__CSL__MSC__SYMBOL.html#gae5caac69e5ad97437dc93eb946bc4f70" title="MSC CSW status macros.">CSL_MSC_CSW_STATUS_COMMAND_PASSED</a>;
<a name="l00632"></a>00632         status = <a class="code" href="group__CSL__USB__FUNCTION.html#ga0976835f84a5fedd800c643e6c86703e">USB_postTransaction</a>(hUsbInEp, smallerLen,
<a name="l00633"></a>00633                                     &amp;pMscHandle-&gt;<a class="code" href="structCSL__MscObject.html#a8a314e64cbbd701737419e82c9b3ffcf" title="Buffer to hold Mode Sense request data.">modeSenseData</a>[1],
<a name="l00634"></a>00634                                     <a class="code" href="group__CSL__USB__SYMBOL.html#ga8874c47ae40bc99a01424c1577538a25">CSL_USB_IOFLAG_NOSHORT</a>);
<a name="l00635"></a>00635 
<a name="l00636"></a>00636         pMscHandle-&gt;<a class="code" href="structCSL__MscObject.html#a311709c730906093e0f06e51a4f46c75" title="The State the Class is in.">storageState</a> = <a class="code" href="group__CSL__MSC__SYMBOL.html#ga880448ac01285aea5e664f781cbc723a">CSL_MSC_STORAGE_STATE_SENDING_DATA</a>;
<a name="l00637"></a>00637     }
<a name="l00638"></a>00638     <span class="keywordflow">else</span>
<a name="l00639"></a>00639     {
<a name="l00640"></a>00640         status = <a class="code" href="group__CSL__MSC__FUNCTION.html#gab9f81a38696a3764b5fa17cc7885cef0">MSC_sendCswWithPhaseError</a>(pMscHandle, hUsbInEp);
<a name="l00641"></a>00641     }
<a name="l00642"></a>00642 
<a name="l00643"></a>00643     <span class="keywordflow">return</span>(status);
<a name="l00644"></a>00644 }
<a name="l00645"></a>00645 
<a name="l00691"></a>00691 <span class="keyword">static</span> <span class="keyword">inline</span>
<a name="l00692"></a><a class="code" href="group__CSL__MSC__FUNCTION.html#gab6f9256ab20a962631b58eb61cb0bcb7">00692</a> CSL_Status <a class="code" href="group__CSL__MSC__FUNCTION.html#gab6f9256ab20a962631b58eb61cb0bcb7">MSC_HandleModeSense10</a>(<a class="code" href="structCSL__MscObject.html" title="MSC Mass Storage Object structure.">CSL_MscObject</a>    *pMscHandle,
<a name="l00693"></a>00693                                  <a class="code" href="structCSL__UsbEpObj.html" title="Data Structure for USB Endpoint Object.">CSL_UsbEpHandle</a>  hUsbInEp,
<a name="l00694"></a>00694                                  Uint16           logicalUnit)
<a name="l00695"></a>00695 {
<a name="l00696"></a>00696     CSL_Status    status;
<a name="l00697"></a>00697     Uint16        modeSenseLen;
<a name="l00698"></a>00698     Uint16        smallerLen;
<a name="l00699"></a>00699 
<a name="l00700"></a>00700     <span class="comment">/* Check whether the data direction is proper or not */</span>
<a name="l00701"></a>00701     <span class="keywordflow">if</span>(((pMscHandle-&gt;<a class="code" href="structCSL__MscObject.html#a33a41cf4247cde09062f4c7f7b6814d3" title="Array used to store the elements of CBW.">cbw</a>[<a class="code" href="group__CSL__MSC__SYMBOL.html#gaf7dfe9ecfa4575b0ec4893220879560a">CSL_MSC_CBW_6</a>] &amp;
<a name="l00702"></a>00702          <a class="code" href="group__CSL__MSC__SYMBOL.html#ga72c7914c91fc0889f7dcbeb9600ca1e3">CSL_MSC_CBW_DIRBIT_MASK</a>) != <a class="code" href="group__CSL__MSC__SYMBOL.html#gac6640009ff518fbfcc735c3b3b8255b8">CSL_MSC_CBW_DATADIR_IN</a>) &amp;&amp;
<a name="l00703"></a>00703         (pMscHandle-&gt;<a class="code" href="structCSL__MscObject.html#aa506ab366c7fc9cd0363c2e0627438d4" title="CBW transfer length.">cbwDataTransferLength</a> != 0))
<a name="l00704"></a>00704     {
<a name="l00705"></a>00705         pMscHandle-&gt;<a class="code" href="structCSL__MscObject.html#abf7ba5452f38545a7e95a7980639bdd5" title="Array used to store the elements of CSW.">csw</a>[<a class="code" href="group__CSL__MSC__SYMBOL.html#ga7d9683c59896b2f3cc94b7d7d0e8989c">CSL_MSC_CSW_6</a>] = <a class="code" href="group__CSL__MSC__SYMBOL.html#gaf58418c4b1da667bd6e1ed1ace4abc61">CSL_MSC_CSW_STATUS_PHASE_ERROR</a>;
<a name="l00706"></a>00706 
<a name="l00707"></a>00707         <span class="comment">/* Stall the end point */</span>
<a name="l00708"></a>00708         pMscHandle-&gt;<a class="code" href="structCSL__MscObject.html#a311709c730906093e0f06e51a4f46c75" title="The State the Class is in.">storageState</a> = <a class="code" href="group__CSL__MSC__SYMBOL.html#gad8d38502cbb73314c7fba3184fb51989">CSL_MSC_STORAGE_STATE_SENDING_STALL</a>;
<a name="l00709"></a>00709         status = <a class="code" href="group__CSL__USB__FUNCTION.html#gaa1befea5ae93ae7079e52df923a54c21">USB_stallEndpt</a>(pMscHandle-&gt;<a class="code" href="structCSL__MscObject.html#adae9f6d49749941398d987f80a4ff2fb" title="Bulk In Endpoint Object Handle.">bulkInEpHandle</a>);
<a name="l00710"></a>00710         status = <a class="code" href="group__CSL__USB__FUNCTION.html#gaa1befea5ae93ae7079e52df923a54c21">USB_stallEndpt</a>(pMscHandle-&gt;<a class="code" href="structCSL__MscObject.html#a0ebf643bf7cce8ae8ed9d85b0947dcf3" title="Bulk Out Endpoint Object Handle.">bulkOutEpHandle</a>);
<a name="l00711"></a>00711 
<a name="l00712"></a>00712         <span class="comment">/* Dummy data transfer to intimate MSC_bulk function */</span>
<a name="l00713"></a>00713         status = <a class="code" href="group__CSL__USB__FUNCTION.html#ga0976835f84a5fedd800c643e6c86703e">USB_postTransaction</a>(pMscHandle-&gt;<a class="code" href="structCSL__MscObject.html#adae9f6d49749941398d987f80a4ff2fb" title="Bulk In Endpoint Object Handle.">bulkInEpHandle</a>,
<a name="l00714"></a>00714                                      0,
<a name="l00715"></a>00715                                      pMscHandle-&gt;<a class="code" href="structCSL__MscObject.html#aab271fb048e57d4e8dd6116dc7fc6206" title="Data buffer pointer used to transfer data to/from Media/usb.">lbaBuffer</a>,
<a name="l00716"></a>00716                                      <a class="code" href="group__CSL__USB__SYMBOL.html#gaaff45fadbb316cd141ef34a431d2f30b">CSL_USB_IOFLAG_NOT</a>);
<a name="l00717"></a>00717         <span class="keywordflow">return</span>(status);
<a name="l00718"></a>00718     }
<a name="l00719"></a>00719 
<a name="l00720"></a>00720     <span class="keywordflow">if</span> (pMscHandle-&gt;<a class="code" href="structCSL__MscObject.html#aa506ab366c7fc9cd0363c2e0627438d4" title="CBW transfer length.">cbwDataTransferLength</a> &gt; 0)
<a name="l00721"></a>00721     {
<a name="l00722"></a>00722         modeSenseLen = pMscHandle-&gt;<a class="code" href="structCSL__MscObject.html#a8a314e64cbbd701737419e82c9b3ffcf" title="Buffer to hold Mode Sense request data.">modeSenseData</a>[0];
<a name="l00723"></a>00723 
<a name="l00724"></a>00724         <span class="comment">/* Getting smaller of the two values */</span>
<a name="l00725"></a>00725         <span class="keywordflow">if</span>(modeSenseLen &lt; pMscHandle-&gt;cbwDataTransferLength)
<a name="l00726"></a>00726         {
<a name="l00727"></a>00727             smallerLen = modeSenseLen;
<a name="l00728"></a>00728         }
<a name="l00729"></a>00729         <span class="keywordflow">else</span>
<a name="l00730"></a>00730         {
<a name="l00731"></a>00731             smallerLen = (Uint16)(pMscHandle-&gt;<a class="code" href="structCSL__MscObject.html#aa506ab366c7fc9cd0363c2e0627438d4" title="CBW transfer length.">cbwDataTransferLength</a> &amp;
<a name="l00732"></a>00732                                   <a class="code" href="group__CSL__MSC__SYMBOL.html#gac7d2c8e5f03a1b00a8837ec4a5481a12">CSL_MSC_16BIT_MASK</a>);
<a name="l00733"></a>00733         }
<a name="l00734"></a>00734 
<a name="l00735"></a>00735         <span class="comment">/* Setting the Data Residue :- Transfer Length - Data transferred */</span>
<a name="l00736"></a>00736         pMscHandle-&gt;<a class="code" href="structCSL__MscObject.html#aa506ab366c7fc9cd0363c2e0627438d4" title="CBW transfer length.">cbwDataTransferLength</a> -= (Uint32)smallerLen;
<a name="l00737"></a>00737         pMscHandle-&gt;<a class="code" href="structCSL__MscObject.html#abf7ba5452f38545a7e95a7980639bdd5" title="Array used to store the elements of CSW.">csw</a>[<a class="code" href="group__CSL__MSC__SYMBOL.html#ga70cb0da786d81c97d7bddd7954742bb1">CSL_MSC_CSW_4</a>] =
<a name="l00738"></a>00738               (Uint16)(pMscHandle-&gt;<a class="code" href="structCSL__MscObject.html#aa506ab366c7fc9cd0363c2e0627438d4" title="CBW transfer length.">cbwDataTransferLength</a> &amp; <a class="code" href="group__CSL__MSC__SYMBOL.html#gac7d2c8e5f03a1b00a8837ec4a5481a12">CSL_MSC_16BIT_MASK</a>);
<a name="l00739"></a>00739         pMscHandle-&gt;<a class="code" href="structCSL__MscObject.html#abf7ba5452f38545a7e95a7980639bdd5" title="Array used to store the elements of CSW.">csw</a>[<a class="code" href="group__CSL__MSC__SYMBOL.html#ga07a9acde81eb85d772a92bfe139accfb">CSL_MSC_CSW_5</a>] =
<a name="l00740"></a>00740               (Uint16)(pMscHandle-&gt;<a class="code" href="structCSL__MscObject.html#aa506ab366c7fc9cd0363c2e0627438d4" title="CBW transfer length.">cbwDataTransferLength</a> &gt;&gt; <a class="code" href="group__CSL__MSC__SYMBOL.html#ga7ffd8a4483cfb8e4791575e212fa3adb">CSL_MSC_16BIT_SHIFT</a>);
<a name="l00741"></a>00741         pMscHandle-&gt;<a class="code" href="structCSL__MscObject.html#abf7ba5452f38545a7e95a7980639bdd5" title="Array used to store the elements of CSW.">csw</a>[<a class="code" href="group__CSL__MSC__SYMBOL.html#ga7d9683c59896b2f3cc94b7d7d0e8989c">CSL_MSC_CSW_6</a>] = <a class="code" href="group__CSL__MSC__SYMBOL.html#gae5caac69e5ad97437dc93eb946bc4f70" title="MSC CSW status macros.">CSL_MSC_CSW_STATUS_COMMAND_PASSED</a>;
<a name="l00742"></a>00742         status = <a class="code" href="group__CSL__USB__FUNCTION.html#ga0976835f84a5fedd800c643e6c86703e">USB_postTransaction</a>(hUsbInEp, smallerLen,
<a name="l00743"></a>00743                                     &amp;pMscHandle-&gt;<a class="code" href="structCSL__MscObject.html#a8a314e64cbbd701737419e82c9b3ffcf" title="Buffer to hold Mode Sense request data.">modeSenseData</a>[1],
<a name="l00744"></a>00744                                     <a class="code" href="group__CSL__USB__SYMBOL.html#ga8874c47ae40bc99a01424c1577538a25">CSL_USB_IOFLAG_NOSHORT</a>);
<a name="l00745"></a>00745 
<a name="l00746"></a>00746         pMscHandle-&gt;<a class="code" href="structCSL__MscObject.html#a311709c730906093e0f06e51a4f46c75" title="The State the Class is in.">storageState</a> = <a class="code" href="group__CSL__MSC__SYMBOL.html#ga880448ac01285aea5e664f781cbc723a">CSL_MSC_STORAGE_STATE_SENDING_DATA</a>;
<a name="l00747"></a>00747     }
<a name="l00748"></a>00748     <span class="keywordflow">else</span>
<a name="l00749"></a>00749     {
<a name="l00750"></a>00750         status = <a class="code" href="group__CSL__MSC__FUNCTION.html#gab9f81a38696a3764b5fa17cc7885cef0">MSC_sendCswWithPhaseError</a>(pMscHandle, hUsbInEp);
<a name="l00751"></a>00751     }
<a name="l00752"></a>00752 
<a name="l00753"></a>00753     <span class="keywordflow">return</span>(status);
<a name="l00754"></a>00754 }
<a name="l00755"></a>00755 
<a name="l00801"></a>00801 <span class="keyword">static</span> <span class="keyword">inline</span>
<a name="l00802"></a><a class="code" href="group__CSL__MSC__FUNCTION.html#gade77de9d2839bc6ec5a7b354ac1276cf">00802</a> CSL_Status <a class="code" href="group__CSL__MSC__FUNCTION.html#gade77de9d2839bc6ec5a7b354ac1276cf">MSC_HandleInquiry</a>(<a class="code" href="structCSL__MscObject.html" title="MSC Mass Storage Object structure.">CSL_MscObject</a>    *pMscHandle,
<a name="l00803"></a>00803                              <a class="code" href="structCSL__UsbEpObj.html" title="Data Structure for USB Endpoint Object.">CSL_UsbEpHandle</a>  hUsbInEp,
<a name="l00804"></a>00804                              Uint16           logicalUnit)
<a name="l00805"></a>00805 {
<a name="l00806"></a>00806     CSL_Status    status;
<a name="l00807"></a>00807     Uint16        cbwRespLen;
<a name="l00808"></a>00808     Uint16        smallerLen;
<a name="l00809"></a>00809 
<a name="l00810"></a>00810     <span class="comment">/* Check whether the data direction is proper or not */</span>
<a name="l00811"></a>00811     <span class="keywordflow">if</span>(((pMscHandle-&gt;<a class="code" href="structCSL__MscObject.html#a33a41cf4247cde09062f4c7f7b6814d3" title="Array used to store the elements of CBW.">cbw</a>[<a class="code" href="group__CSL__MSC__SYMBOL.html#gaf7dfe9ecfa4575b0ec4893220879560a">CSL_MSC_CBW_6</a>] &amp;
<a name="l00812"></a>00812          <a class="code" href="group__CSL__MSC__SYMBOL.html#ga72c7914c91fc0889f7dcbeb9600ca1e3">CSL_MSC_CBW_DIRBIT_MASK</a>) != <a class="code" href="group__CSL__MSC__SYMBOL.html#gac6640009ff518fbfcc735c3b3b8255b8">CSL_MSC_CBW_DATADIR_IN</a>) &amp;&amp;
<a name="l00813"></a>00813         (pMscHandle-&gt;<a class="code" href="structCSL__MscObject.html#aa506ab366c7fc9cd0363c2e0627438d4" title="CBW transfer length.">cbwDataTransferLength</a> != 0))
<a name="l00814"></a>00814     {
<a name="l00815"></a>00815         status = <a class="code" href="group__CSL__MSC__FUNCTION.html#gabd34a0a4aeb1dc85c741520f91dfa11a">MSC_handleDataDirMisMatch</a>(pMscHandle, <a class="code" href="group__CSL__MSC__SYMBOL.html#gac6640009ff518fbfcc735c3b3b8255b8">CSL_MSC_CBW_DATADIR_IN</a>);
<a name="l00816"></a>00816 
<a name="l00817"></a>00817         <span class="keywordflow">return</span>(status);
<a name="l00818"></a>00818     }
<a name="l00819"></a>00819 
<a name="l00820"></a>00820     <span class="keywordflow">if</span> (pMscHandle-&gt;<a class="code" href="structCSL__MscObject.html#aa506ab366c7fc9cd0363c2e0627438d4" title="CBW transfer length.">cbwDataTransferLength</a> &gt; 0)
<a name="l00821"></a>00821     {
<a name="l00822"></a>00822         cbwRespLen = pMscHandle-&gt;<a class="code" href="structCSL__MscObject.html#a32da56160cb70b1ec9669b640b8f0198" title="Data pertaining to Logical Units Supported.">lun</a>[logicalUnit].<a class="code" href="structCSL__MscLogicalUnit.html#ab630c7d6a2d6d2310e61c831a80d9b1f" title="SCSI Inquiry Data.">scsiInquiryData</a>[0];
<a name="l00823"></a>00823         <span class="comment">/* Getting smaller of the two values */</span>
<a name="l00824"></a>00824         <span class="keywordflow">if</span>(cbwRespLen &lt; pMscHandle-&gt;cbwDataTransferLength)
<a name="l00825"></a>00825         {
<a name="l00826"></a>00826             smallerLen = cbwRespLen;
<a name="l00827"></a>00827             pMscHandle-&gt;<a class="code" href="structCSL__MscObject.html#a311709c730906093e0f06e51a4f46c75" title="The State the Class is in.">storageState</a> = <a class="code" href="group__CSL__MSC__SYMBOL.html#gaa10361c922a1ba9b836e683fe971bd05">CSL_MSC_STORAGE_STATE_SENDING_SHORT_PKT</a>;
<a name="l00828"></a>00828         }
<a name="l00829"></a>00829         <span class="keywordflow">else</span>
<a name="l00830"></a>00830         {
<a name="l00831"></a>00831             smallerLen = (Uint16)(pMscHandle-&gt;<a class="code" href="structCSL__MscObject.html#aa506ab366c7fc9cd0363c2e0627438d4" title="CBW transfer length.">cbwDataTransferLength</a> &amp;
<a name="l00832"></a>00832                                   <a class="code" href="group__CSL__MSC__SYMBOL.html#gac7d2c8e5f03a1b00a8837ec4a5481a12">CSL_MSC_16BIT_MASK</a>);
<a name="l00833"></a>00833             pMscHandle-&gt;<a class="code" href="structCSL__MscObject.html#a311709c730906093e0f06e51a4f46c75" title="The State the Class is in.">storageState</a> = <a class="code" href="group__CSL__MSC__SYMBOL.html#ga880448ac01285aea5e664f781cbc723a">CSL_MSC_STORAGE_STATE_SENDING_DATA</a>;
<a name="l00834"></a>00834         }
<a name="l00835"></a>00835 
<a name="l00836"></a>00836         <span class="comment">/* Setting the Data Residue :- Transfer Length - Data transferred */</span>
<a name="l00837"></a>00837         pMscHandle-&gt;<a class="code" href="structCSL__MscObject.html#aa506ab366c7fc9cd0363c2e0627438d4" title="CBW transfer length.">cbwDataTransferLength</a> -= (Uint32)smallerLen;
<a name="l00838"></a>00838         pMscHandle-&gt;<a class="code" href="structCSL__MscObject.html#abf7ba5452f38545a7e95a7980639bdd5" title="Array used to store the elements of CSW.">csw</a>[<a class="code" href="group__CSL__MSC__SYMBOL.html#ga70cb0da786d81c97d7bddd7954742bb1">CSL_MSC_CSW_4</a>] =
<a name="l00839"></a>00839              (Uint16)(pMscHandle-&gt;<a class="code" href="structCSL__MscObject.html#aa506ab366c7fc9cd0363c2e0627438d4" title="CBW transfer length.">cbwDataTransferLength</a> &amp; <a class="code" href="group__CSL__MSC__SYMBOL.html#gac7d2c8e5f03a1b00a8837ec4a5481a12">CSL_MSC_16BIT_MASK</a>);
<a name="l00840"></a>00840         pMscHandle-&gt;<a class="code" href="structCSL__MscObject.html#abf7ba5452f38545a7e95a7980639bdd5" title="Array used to store the elements of CSW.">csw</a>[<a class="code" href="group__CSL__MSC__SYMBOL.html#ga07a9acde81eb85d772a92bfe139accfb">CSL_MSC_CSW_5</a>] =
<a name="l00841"></a>00841              (Uint16)(pMscHandle-&gt;<a class="code" href="structCSL__MscObject.html#aa506ab366c7fc9cd0363c2e0627438d4" title="CBW transfer length.">cbwDataTransferLength</a> &gt;&gt; <a class="code" href="group__CSL__MSC__SYMBOL.html#ga7ffd8a4483cfb8e4791575e212fa3adb">CSL_MSC_16BIT_SHIFT</a>);
<a name="l00842"></a>00842         pMscHandle-&gt;<a class="code" href="structCSL__MscObject.html#abf7ba5452f38545a7e95a7980639bdd5" title="Array used to store the elements of CSW.">csw</a>[<a class="code" href="group__CSL__MSC__SYMBOL.html#ga7d9683c59896b2f3cc94b7d7d0e8989c">CSL_MSC_CSW_6</a>] = <a class="code" href="group__CSL__MSC__SYMBOL.html#gae5caac69e5ad97437dc93eb946bc4f70" title="MSC CSW status macros.">CSL_MSC_CSW_STATUS_COMMAND_PASSED</a>;
<a name="l00843"></a>00843 
<a name="l00844"></a>00844         status = <a class="code" href="group__CSL__USB__FUNCTION.html#ga0976835f84a5fedd800c643e6c86703e">USB_postTransaction</a>(hUsbInEp, smallerLen,
<a name="l00845"></a>00845                                  &amp;pMscHandle-&gt;<a class="code" href="structCSL__MscObject.html#a32da56160cb70b1ec9669b640b8f0198" title="Data pertaining to Logical Units Supported.">lun</a>[logicalUnit].<a class="code" href="structCSL__MscLogicalUnit.html#ab630c7d6a2d6d2310e61c831a80d9b1f" title="SCSI Inquiry Data.">scsiInquiryData</a>[1],
<a name="l00846"></a>00846                                  <a class="code" href="group__CSL__USB__SYMBOL.html#ga8874c47ae40bc99a01424c1577538a25">CSL_USB_IOFLAG_NOSHORT</a>);
<a name="l00847"></a>00847     }
<a name="l00848"></a>00848     <span class="keywordflow">else</span>
<a name="l00849"></a>00849     {
<a name="l00850"></a>00850         status = <a class="code" href="group__CSL__MSC__FUNCTION.html#gab9f81a38696a3764b5fa17cc7885cef0">MSC_sendCswWithPhaseError</a>(pMscHandle, hUsbInEp);
<a name="l00851"></a>00851     }
<a name="l00852"></a>00852 
<a name="l00853"></a>00853     <span class="keywordflow">return</span>(status);
<a name="l00854"></a>00854 }
<a name="l00855"></a>00855 
<a name="l00900"></a>00900 <span class="keyword">static</span> <span class="keyword">inline</span>
<a name="l00901"></a><a class="code" href="group__CSL__MSC__FUNCTION.html#ga49469e6925eafc334bd55aa4bc5f3267">00901</a> CSL_Status <a class="code" href="group__CSL__MSC__FUNCTION.html#ga49469e6925eafc334bd55aa4bc5f3267">MSC_HandleRequestSense</a>(<a class="code" href="structCSL__MscObject.html" title="MSC Mass Storage Object structure.">CSL_MscObject</a>    *pMscHandle,
<a name="l00902"></a>00902                                   <a class="code" href="structCSL__UsbEpObj.html" title="Data Structure for USB Endpoint Object.">CSL_UsbEpHandle</a>  hUsbInEp)
<a name="l00903"></a>00903 {
<a name="l00904"></a>00904     CSL_Status    status;
<a name="l00905"></a>00905     Uint16        cbwRespLen;
<a name="l00906"></a>00906     Uint16        smallerLen;
<a name="l00907"></a>00907 
<a name="l00908"></a>00908     <span class="comment">/* Check whether the data direction is proper or not */</span>
<a name="l00909"></a>00909     <span class="keywordflow">if</span>(((pMscHandle-&gt;<a class="code" href="structCSL__MscObject.html#a33a41cf4247cde09062f4c7f7b6814d3" title="Array used to store the elements of CBW.">cbw</a>[<a class="code" href="group__CSL__MSC__SYMBOL.html#gaf7dfe9ecfa4575b0ec4893220879560a">CSL_MSC_CBW_6</a>] &amp;
<a name="l00910"></a>00910          <a class="code" href="group__CSL__MSC__SYMBOL.html#ga72c7914c91fc0889f7dcbeb9600ca1e3">CSL_MSC_CBW_DIRBIT_MASK</a>) != <a class="code" href="group__CSL__MSC__SYMBOL.html#gac6640009ff518fbfcc735c3b3b8255b8">CSL_MSC_CBW_DATADIR_IN</a>) &amp;&amp;
<a name="l00911"></a>00911         (pMscHandle-&gt;<a class="code" href="structCSL__MscObject.html#aa506ab366c7fc9cd0363c2e0627438d4" title="CBW transfer length.">cbwDataTransferLength</a> != 0))
<a name="l00912"></a>00912     {
<a name="l00913"></a>00913         status = <a class="code" href="group__CSL__MSC__FUNCTION.html#gabd34a0a4aeb1dc85c741520f91dfa11a">MSC_handleDataDirMisMatch</a>(pMscHandle, <a class="code" href="group__CSL__MSC__SYMBOL.html#gac6640009ff518fbfcc735c3b3b8255b8">CSL_MSC_CBW_DATADIR_IN</a>);
<a name="l00914"></a>00914 
<a name="l00915"></a>00915         <span class="keywordflow">return</span>(status);
<a name="l00916"></a>00916     }
<a name="l00917"></a>00917 
<a name="l00918"></a>00918     <span class="keywordflow">if</span> (pMscHandle-&gt;<a class="code" href="structCSL__MscObject.html#aa506ab366c7fc9cd0363c2e0627438d4" title="CBW transfer length.">cbwDataTransferLength</a> &gt; 0)
<a name="l00919"></a>00919     {
<a name="l00920"></a>00920         cbwRespLen = pMscHandle-&gt;<a class="code" href="structCSL__MscObject.html#a6e3a1597b42e91ccb56d4f26c87fbd0e" title="Sense Data Array.">senseData</a>[0];
<a name="l00921"></a>00921 
<a name="l00922"></a>00922         <span class="comment">/* Getting smaller of the two values */</span>
<a name="l00923"></a>00923         <span class="keywordflow">if</span>(cbwRespLen &lt; pMscHandle-&gt;cbwDataTransferLength)
<a name="l00924"></a>00924         {
<a name="l00925"></a>00925             pMscHandle-&gt;<a class="code" href="structCSL__MscObject.html#a311709c730906093e0f06e51a4f46c75" title="The State the Class is in.">storageState</a> = <a class="code" href="group__CSL__MSC__SYMBOL.html#gaa10361c922a1ba9b836e683fe971bd05">CSL_MSC_STORAGE_STATE_SENDING_SHORT_PKT</a>;
<a name="l00926"></a>00926             smallerLen = cbwRespLen;
<a name="l00927"></a>00927         }
<a name="l00928"></a>00928         <span class="keywordflow">else</span>
<a name="l00929"></a>00929         {
<a name="l00930"></a>00930             pMscHandle-&gt;<a class="code" href="structCSL__MscObject.html#a311709c730906093e0f06e51a4f46c75" title="The State the Class is in.">storageState</a> = <a class="code" href="group__CSL__MSC__SYMBOL.html#ga880448ac01285aea5e664f781cbc723a">CSL_MSC_STORAGE_STATE_SENDING_DATA</a>;
<a name="l00931"></a>00931 
<a name="l00932"></a>00932             smallerLen= (Uint16)(pMscHandle-&gt;<a class="code" href="structCSL__MscObject.html#aa506ab366c7fc9cd0363c2e0627438d4" title="CBW transfer length.">cbwDataTransferLength</a> &amp;
<a name="l00933"></a>00933                                  <a class="code" href="group__CSL__MSC__SYMBOL.html#gac7d2c8e5f03a1b00a8837ec4a5481a12">CSL_MSC_16BIT_MASK</a>);
<a name="l00934"></a>00934         }
<a name="l00935"></a>00935 
<a name="l00936"></a>00936         <span class="comment">/* Setting the Data Residue :- Transfer Length - Data transferred */</span>
<a name="l00937"></a>00937         pMscHandle-&gt;<a class="code" href="structCSL__MscObject.html#aa506ab366c7fc9cd0363c2e0627438d4" title="CBW transfer length.">cbwDataTransferLength</a> -= (Uint32)smallerLen;
<a name="l00938"></a>00938         pMscHandle-&gt;<a class="code" href="structCSL__MscObject.html#abf7ba5452f38545a7e95a7980639bdd5" title="Array used to store the elements of CSW.">csw</a>[<a class="code" href="group__CSL__MSC__SYMBOL.html#ga70cb0da786d81c97d7bddd7954742bb1">CSL_MSC_CSW_4</a>] =
<a name="l00939"></a>00939                (Uint16)(pMscHandle-&gt;<a class="code" href="structCSL__MscObject.html#aa506ab366c7fc9cd0363c2e0627438d4" title="CBW transfer length.">cbwDataTransferLength</a> &amp; <a class="code" href="group__CSL__MSC__SYMBOL.html#ga7ffd8a4483cfb8e4791575e212fa3adb">CSL_MSC_16BIT_SHIFT</a>);
<a name="l00940"></a>00940         pMscHandle-&gt;<a class="code" href="structCSL__MscObject.html#abf7ba5452f38545a7e95a7980639bdd5" title="Array used to store the elements of CSW.">csw</a>[<a class="code" href="group__CSL__MSC__SYMBOL.html#ga07a9acde81eb85d772a92bfe139accfb">CSL_MSC_CSW_5</a>] =
<a name="l00941"></a>00941                (Uint16)(pMscHandle-&gt;<a class="code" href="structCSL__MscObject.html#aa506ab366c7fc9cd0363c2e0627438d4" title="CBW transfer length.">cbwDataTransferLength</a> &gt;&gt; <a class="code" href="group__CSL__MSC__SYMBOL.html#ga7ffd8a4483cfb8e4791575e212fa3adb">CSL_MSC_16BIT_SHIFT</a>);
<a name="l00942"></a>00942         pMscHandle-&gt;<a class="code" href="structCSL__MscObject.html#abf7ba5452f38545a7e95a7980639bdd5" title="Array used to store the elements of CSW.">csw</a>[<a class="code" href="group__CSL__MSC__SYMBOL.html#ga7d9683c59896b2f3cc94b7d7d0e8989c">CSL_MSC_CSW_6</a>] = <a class="code" href="group__CSL__MSC__SYMBOL.html#gae5caac69e5ad97437dc93eb946bc4f70" title="MSC CSW status macros.">CSL_MSC_CSW_STATUS_COMMAND_PASSED</a>;
<a name="l00943"></a>00943         status = <a class="code" href="group__CSL__USB__FUNCTION.html#ga0976835f84a5fedd800c643e6c86703e">USB_postTransaction</a>(hUsbInEp, smallerLen,
<a name="l00944"></a>00944                                      &amp;pMscHandle-&gt;<a class="code" href="structCSL__MscObject.html#a6e3a1597b42e91ccb56d4f26c87fbd0e" title="Sense Data Array.">senseData</a>[1],
<a name="l00945"></a>00945                                      <a class="code" href="group__CSL__USB__SYMBOL.html#ga8874c47ae40bc99a01424c1577538a25">CSL_USB_IOFLAG_NOSHORT</a>);
<a name="l00946"></a>00946     }
<a name="l00947"></a>00947     <span class="keywordflow">else</span>
<a name="l00948"></a>00948     {
<a name="l00949"></a>00949         status = <a class="code" href="group__CSL__MSC__FUNCTION.html#gab9f81a38696a3764b5fa17cc7885cef0">MSC_sendCswWithPhaseError</a>(pMscHandle, hUsbInEp);
<a name="l00950"></a>00950     }
<a name="l00951"></a>00951 
<a name="l00952"></a>00952     <span class="keywordflow">return</span>(status);
<a name="l00953"></a>00953 }
<a name="l00954"></a>00954 
<a name="l01000"></a>01000 <span class="keyword">static</span> <span class="keyword">inline</span>
<a name="l01001"></a><a class="code" href="group__CSL__MSC__FUNCTION.html#ga4b07c75b1cd2664b4f3661ac4e363ef9">01001</a> CSL_Status <a class="code" href="group__CSL__MSC__FUNCTION.html#ga4b07c75b1cd2664b4f3661ac4e363ef9">MSC_HandleVerify10</a>(<a class="code" href="structCSL__MscObject.html" title="MSC Mass Storage Object structure.">CSL_MscObject</a>    *pMscHandle,
<a name="l01002"></a>01002                               <a class="code" href="structCSL__UsbEpObj.html" title="Data Structure for USB Endpoint Object.">CSL_UsbEpHandle</a>  hUsbInEp,
<a name="l01003"></a>01003                               Uint16           logicalUnit)
<a name="l01004"></a>01004 {
<a name="l01005"></a>01005     CSL_Status    status;
<a name="l01006"></a>01006     Uint16        verifyLen;
<a name="l01007"></a>01007 
<a name="l01008"></a>01008     <span class="keywordflow">if</span> (pMscHandle-&gt;<a class="code" href="structCSL__MscObject.html#aa506ab366c7fc9cd0363c2e0627438d4" title="CBW transfer length.">cbwDataTransferLength</a> != 0)
<a name="l01009"></a>01009     {
<a name="l01010"></a>01010         <span class="comment">/* Stall the end point */</span>
<a name="l01011"></a>01011         pMscHandle-&gt;<a class="code" href="structCSL__MscObject.html#a311709c730906093e0f06e51a4f46c75" title="The State the Class is in.">storageState</a> = <a class="code" href="group__CSL__MSC__SYMBOL.html#gad8d38502cbb73314c7fba3184fb51989">CSL_MSC_STORAGE_STATE_SENDING_STALL</a>;
<a name="l01012"></a>01012         status = <a class="code" href="group__CSL__USB__FUNCTION.html#gaa1befea5ae93ae7079e52df923a54c21">USB_stallEndpt</a>(pMscHandle-&gt;<a class="code" href="structCSL__MscObject.html#a0ebf643bf7cce8ae8ed9d85b0947dcf3" title="Bulk Out Endpoint Object Handle.">bulkOutEpHandle</a>);
<a name="l01013"></a>01013         status = <a class="code" href="group__CSL__USB__FUNCTION.html#gaa1befea5ae93ae7079e52df923a54c21">USB_stallEndpt</a>(pMscHandle-&gt;<a class="code" href="structCSL__MscObject.html#adae9f6d49749941398d987f80a4ff2fb" title="Bulk In Endpoint Object Handle.">bulkInEpHandle</a>);
<a name="l01014"></a>01014 
<a name="l01015"></a>01015 
<a name="l01016"></a>01016         <span class="comment">/* Dummy data transfer to intimate MSC_bulk function */</span>
<a name="l01017"></a>01017         status |= <a class="code" href="group__CSL__USB__FUNCTION.html#ga0976835f84a5fedd800c643e6c86703e">USB_postTransaction</a>(pMscHandle-&gt;<a class="code" href="structCSL__MscObject.html#adae9f6d49749941398d987f80a4ff2fb" title="Bulk In Endpoint Object Handle.">bulkInEpHandle</a>,
<a name="l01018"></a>01018                                      0,
<a name="l01019"></a>01019                                      pMscHandle-&gt;<a class="code" href="structCSL__MscObject.html#aab271fb048e57d4e8dd6116dc7fc6206" title="Data buffer pointer used to transfer data to/from Media/usb.">lbaBuffer</a>,
<a name="l01020"></a>01020                                      <a class="code" href="group__CSL__USB__SYMBOL.html#gaaff45fadbb316cd141ef34a431d2f30b">CSL_USB_IOFLAG_NOT</a>);
<a name="l01021"></a>01021 
<a name="l01022"></a>01022         <span class="keywordflow">return</span>(status);
<a name="l01023"></a>01023     }
<a name="l01024"></a>01024 
<a name="l01025"></a>01025     verifyLen = ((pMscHandle-&gt;<a class="code" href="structCSL__MscObject.html#a33a41cf4247cde09062f4c7f7b6814d3" title="Array used to store the elements of CBW.">cbw</a>[<a class="code" href="group__CSL__MSC__SYMBOL.html#gac9fa867748fca8db64b0309dcd36f580">CSL_MSC_CBW_11</a>] &amp; <a class="code" href="group__CSL__MSC__SYMBOL.html#gabdac328f47cf783c8b8a01fff062348f">CSL_MSC_8BIT_MASK</a>) &lt;&lt;
<a name="l01026"></a>01026                  <a class="code" href="group__CSL__MSC__SYMBOL.html#gac63c387b97d17851047edf275a87ff3f">CSL_MSC_8BIT_SHIFT</a>)|((pMscHandle-&gt;<a class="code" href="structCSL__MscObject.html#a33a41cf4247cde09062f4c7f7b6814d3" title="Array used to store the elements of CBW.">cbw</a>[<a class="code" href="group__CSL__MSC__SYMBOL.html#gac9fa867748fca8db64b0309dcd36f580">CSL_MSC_CBW_11</a>] &amp;
<a name="l01027"></a>01027                  <a class="code" href="group__CSL__MSC__SYMBOL.html#gacee05085b736468e10fbd23329d2c23f">CSL_MSC_8BIT_HIGH_MASK</a>) &gt;&gt; <a class="code" href="group__CSL__MSC__SYMBOL.html#gac63c387b97d17851047edf275a87ff3f">CSL_MSC_8BIT_SHIFT</a>);
<a name="l01028"></a>01028 
<a name="l01029"></a>01029     <span class="keywordflow">if</span>((pMscHandle-&gt;<a class="code" href="structCSL__MscObject.html#a32da56160cb70b1ec9669b640b8f0198" title="Data pertaining to Logical Units Supported.">lun</a>[logicalUnit].<a class="code" href="structCSL__MscLogicalUnit.html#a24f6a1bd70584b735196b1879652132a" title="Contains status of previous write in this variable.">verifyFlag</a> == <a class="code" href="group__CSL__MSC__SYMBOL.html#ga97db504c4c7449b92761b4bd59e22285" title="USB MSC status and size definitions.">CSL_MSC_VERIFY_PASSED</a>) ||
<a name="l01030"></a>01030        (verifyLen == 0))
<a name="l01031"></a>01031     {
<a name="l01032"></a>01032         pMscHandle-&gt;<a class="code" href="structCSL__MscObject.html#abf7ba5452f38545a7e95a7980639bdd5" title="Array used to store the elements of CSW.">csw</a>[<a class="code" href="group__CSL__MSC__SYMBOL.html#ga7d9683c59896b2f3cc94b7d7d0e8989c">CSL_MSC_CSW_6</a>] = <a class="code" href="group__CSL__MSC__SYMBOL.html#gae5caac69e5ad97437dc93eb946bc4f70" title="MSC CSW status macros.">CSL_MSC_CSW_STATUS_COMMAND_PASSED</a>;
<a name="l01033"></a>01033     }
<a name="l01034"></a>01034     <span class="keywordflow">else</span>
<a name="l01035"></a>01035     {
<a name="l01036"></a>01036         pMscHandle-&gt;<a class="code" href="structCSL__MscObject.html#abf7ba5452f38545a7e95a7980639bdd5" title="Array used to store the elements of CSW.">csw</a>[<a class="code" href="group__CSL__MSC__SYMBOL.html#ga7d9683c59896b2f3cc94b7d7d0e8989c">CSL_MSC_CSW_6</a>] = <a class="code" href="group__CSL__MSC__SYMBOL.html#gacf6aa3954cb8b1d6fdac285b42a0fe8c">CSL_MSC_CSW_STATUS_COMMAND_FAILED</a>;
<a name="l01037"></a>01037         <a class="code" href="group__CSL__MSC__FUNCTION.html#ga9d0453399a7bc52edcd2a51a2af31151">MSC_SetSenseKeys</a>(pMscHandle-&gt;<a class="code" href="structCSL__MscObject.html#a6e3a1597b42e91ccb56d4f26c87fbd0e" title="Sense Data Array.">senseData</a>,
<a name="l01038"></a>01038             <a class="code" href="group__CSL__MSC__SYMBOL.html#gaca26b8cdc8333de9ff49333078c62b4e">CSL_MSC_SCSI_SENSEKEY_MISCOMPARE</a>,
<a name="l01039"></a>01039             <a class="code" href="group__CSL__MSC__SYMBOL.html#gac3e9562533244a10381dc6ad5066e050">CSL_MSC_SCSI_ASC_MISCOMPARE_VERIFY</a>);
<a name="l01040"></a>01040     }
<a name="l01041"></a>01041 
<a name="l01042"></a>01042     pMscHandle-&gt;<a class="code" href="structCSL__MscObject.html#a311709c730906093e0f06e51a4f46c75" title="The State the Class is in.">storageState</a> = <a class="code" href="group__CSL__MSC__SYMBOL.html#ga047ba96281d1712fcf0ab9ffa4c2cfd3">CSL_MSC_STORAGE_STATE_SENDING_CSW</a>;
<a name="l01043"></a>01043     status = <a class="code" href="group__CSL__USB__FUNCTION.html#ga0976835f84a5fedd800c643e6c86703e">USB_postTransaction</a>(hUsbInEp, <a class="code" href="group__CSL__MSC__SYMBOL.html#ga1cd8224df387eedf86e95e1019454d89">CSL_MSC_CSW_DATA_SIZE</a>,
<a name="l01044"></a>01044                                  &amp;pMscHandle-&gt;<a class="code" href="structCSL__MscObject.html#abf7ba5452f38545a7e95a7980639bdd5" title="Array used to store the elements of CSW.">csw</a>[0], <a class="code" href="group__CSL__USB__SYMBOL.html#ga8874c47ae40bc99a01424c1577538a25">CSL_USB_IOFLAG_NOSHORT</a>);
<a name="l01045"></a>01045 
<a name="l01046"></a>01046     <span class="keywordflow">return</span>(status);
<a name="l01047"></a>01047 }
<a name="l01048"></a>01048 
<a name="l01103"></a>01103 <span class="keyword">static</span> <span class="keyword">inline</span>
<a name="l01104"></a><a class="code" href="group__CSL__MSC__FUNCTION.html#gaf0df312be8af0f9c03a883a9ecd6eec7">01104</a> <a class="code" href="group__CSL__MSC__ENUM.html#ga9324e3a9461945d734f76af9753281c1" title="This Enum defines the Msc request return values.">CSL_MscRequestRet</a> <a class="code" href="group__CSL__MSC__FUNCTION.html#gaf0df312be8af0f9c03a883a9ecd6eec7">MSC_reqUnknown</a>(<a class="code" href="structCSL__UsbContext.html" title="USB context information structure.">CSL_UsbDevHandle</a>      devHandle,
<a name="l01105"></a>01105                                  <a class="code" href="structCSL__UsbSetupStruct.html" title="Data structure to hold USB setup packet.">CSL_UsbSetupStruct</a>    *usbSetup,
<a name="l01106"></a>01106                                  <a class="code" href="structCSL__UsbEpObj.html" title="Data Structure for USB Endpoint Object.">CSL_UsbEpHandle</a>       hInEp,
<a name="l01107"></a>01107                                  <a class="code" href="structCSL__UsbEpObj.html" title="Data Structure for USB Endpoint Object.">CSL_UsbEpHandle</a>       hOutEp,
<a name="l01108"></a>01108                                  <span class="keywordtype">void</span>                  *pMsc)
<a name="l01109"></a>01109 {
<a name="l01110"></a>01110     <a class="code" href="group__CSL__MSC__ENUM.html#ga9324e3a9461945d734f76af9753281c1" title="This Enum defines the Msc request return values.">CSL_MscRequestRet</a>    retStat;
<a name="l01111"></a>01111 
<a name="l01112"></a>01112     <span class="comment">/* STALL the endpoint - the request is either not known or not supported */</span>
<a name="l01113"></a>01113     retStat = CSL_MSC_REQUEST_STALL;
<a name="l01114"></a>01114 
<a name="l01115"></a>01115     <span class="keywordflow">return</span>(retStat);
<a name="l01116"></a>01116 }
<a name="l01117"></a>01117 
<a name="l01168"></a>01168 <span class="keyword">static</span> <span class="keyword">inline</span>
<a name="l01169"></a><a class="code" href="group__CSL__MSC__FUNCTION.html#ga1c98c6892a574120df648d84d1de0c17">01169</a> <a class="code" href="group__CSL__MSC__DATASTRUCT.html#gad0d0fb6cc48f2a9d9dd04410020c81b5" title="MSC request handler function pointer.">fpMSC_REQ_HANDLER</a> <a class="code" href="group__CSL__MSC__FUNCTION.html#ga1c98c6892a574120df648d84d1de0c17">MSC_lookupReqHandler</a>(Uint16                  request,
<a name="l01170"></a>01170                                        <a class="code" href="structCSL__MscRequestStruct.html" title="MSC control request structure.">CSL_MscRequestStruct</a>    *pUSB_ReqTable)
<a name="l01171"></a>01171 {
<a name="l01172"></a>01172     Uint16    index;
<a name="l01173"></a>01173 
<a name="l01174"></a>01174     <span class="comment">/* parse thru the end of request handler table */</span>
<a name="l01175"></a>01175     <span class="keywordflow">for</span>(index = 0; pUSB_ReqTable[index].<a class="code" href="structCSL__MscRequestStruct.html#afb0accdd0d64494479aee8b035e9c6cc" title="MSC control request handler pointer.">fpRequestHandler</a> != NULL; index++)
<a name="l01176"></a>01176     {
<a name="l01177"></a>01177         <span class="comment">/* if request handler exists return a pointer to the request handler routine */</span>
<a name="l01178"></a>01178         <span class="keywordflow">if</span>(pUSB_ReqTable[index].request == request)
<a name="l01179"></a>01179         {
<a name="l01180"></a>01180             <span class="keywordflow">return</span>(pUSB_ReqTable[index].fpRequestHandler);
<a name="l01181"></a>01181         }
<a name="l01182"></a>01182     }
<a name="l01183"></a>01183 
<a name="l01184"></a>01184     <span class="comment">/* if request handler does not exist return a pointer to the USB_reqUnknown</span>
<a name="l01185"></a>01185 <span class="comment">    routine */</span>
<a name="l01186"></a>01186     <span class="keywordflow">return</span>(<a class="code" href="group__CSL__MSC__FUNCTION.html#gaf0df312be8af0f9c03a883a9ecd6eec7">MSC_reqUnknown</a>);
<a name="l01187"></a>01187 }
<a name="l01188"></a>01188 
<a name="l01242"></a>01242 <span class="keyword">static</span> <span class="keyword">inline</span>
<a name="l01243"></a><a class="code" href="group__CSL__MSC__FUNCTION.html#ga21286b327b55fe554b6c1651406be8bc">01243</a> <a class="code" href="group__CSL__MSC__ENUM.html#ga9324e3a9461945d734f76af9753281c1" title="This Enum defines the Msc request return values.">CSL_MscRequestRet</a> <a class="code" href="group__CSL__MSC__FUNCTION.html#ga21286b327b55fe554b6c1651406be8bc">MSC_reqSetAddress</a>(<a class="code" href="structCSL__UsbContext.html" title="USB context information structure.">CSL_UsbDevHandle</a>      devHandle,
<a name="l01244"></a>01244                                     <a class="code" href="structCSL__UsbSetupStruct.html" title="Data structure to hold USB setup packet.">CSL_UsbSetupStruct</a>    *usbSetup,
<a name="l01245"></a>01245                                     <a class="code" href="structCSL__UsbEpObj.html" title="Data Structure for USB Endpoint Object.">CSL_UsbEpHandle</a>       hInEp,
<a name="l01246"></a>01246                                     <a class="code" href="structCSL__UsbEpObj.html" title="Data Structure for USB Endpoint Object.">CSL_UsbEpHandle</a>       hOutEp,
<a name="l01247"></a>01247                                     <span class="keywordtype">void</span>                  *pMsc)
<a name="l01248"></a>01248 {
<a name="l01249"></a>01249     <a class="code" href="group__CSL__USB__FUNCTION.html#ga25cb72d6bce692e49d554479df7c9173">USB_setDevAddr</a>(devHandle, (Uint16)(usbSetup-&gt;<a class="code" href="structCSL__UsbSetupStruct.html#a20b94e0080d670cfd371b622838f24a7" title="Byte 2 and 3 of setup packet.">wValue</a>));
<a name="l01250"></a>01250 
<a name="l01251"></a>01251     <span class="keywordflow">return</span>(CSL_MSC_REQUEST_DONE);
<a name="l01252"></a>01252 }
<a name="l01253"></a>01253 
<a name="l01308"></a>01308 <span class="keyword">static</span> <span class="keyword">inline</span>
<a name="l01309"></a><a class="code" href="group__CSL__MSC__FUNCTION.html#ga3a4d663a672e9604cb98e5f69dd26e1b">01309</a> <a class="code" href="group__CSL__MSC__ENUM.html#ga9324e3a9461945d734f76af9753281c1" title="This Enum defines the Msc request return values.">CSL_MscRequestRet</a> <a class="code" href="group__CSL__MSC__FUNCTION.html#ga3a4d663a672e9604cb98e5f69dd26e1b">MSC_reqSetConfiguration</a>(<a class="code" href="structCSL__UsbContext.html" title="USB context information structure.">CSL_UsbDevHandle</a>      devHandle,
<a name="l01310"></a>01310                                           <a class="code" href="structCSL__UsbSetupStruct.html" title="Data structure to hold USB setup packet.">CSL_UsbSetupStruct</a>    *usbSetup,
<a name="l01311"></a>01311                                           <a class="code" href="structCSL__UsbEpObj.html" title="Data Structure for USB Endpoint Object.">CSL_UsbEpHandle</a>       hInEp,
<a name="l01312"></a>01312                                           <a class="code" href="structCSL__UsbEpObj.html" title="Data Structure for USB Endpoint Object.">CSL_UsbEpHandle</a>       hOutEp,
<a name="l01313"></a>01313                                           <span class="keywordtype">void</span>                  *pMsc)
<a name="l01314"></a>01314 {
<a name="l01315"></a>01315     <a class="code" href="group__CSL__MSC__ENUM.html#ga9324e3a9461945d734f76af9753281c1" title="This Enum defines the Msc request return values.">CSL_MscRequestRet</a>    retStat;
<a name="l01316"></a>01316 
<a name="l01317"></a>01317     <a class="code" href="structCSL__MscClassStruct.html" title="MSC Control Object structure.">pMscClassHandle</a>      pMscClassHdl;
<a name="l01318"></a>01318     <a class="code" href="structCSL__MscCtrlObject.html" title="MSC Control Object structure.">CSL_MscCtrlObject</a>    *pCtrlHandle;
<a name="l01319"></a>01319 
<a name="l01320"></a>01320     pMscClassHdl = (<a class="code" href="group__CSL__MSC__DATASTRUCT.html#ga097887623ed20e9e67aa07e992a90d94" title="MSc class handle.">pMscClassHandle</a>)(pMsc);
<a name="l01321"></a>01321     pCtrlHandle  = &amp;pMscClassHdl-&gt;<a class="code" href="structCSL__MscClassStruct.html#a671312a4c84719cc8f327db5f02e7a05" title="Handle to Control Object.">ctrlHandle</a>;
<a name="l01322"></a>01322 
<a name="l01323"></a>01323     <span class="keywordflow">if</span>((usbSetup-&gt;<a class="code" href="structCSL__UsbSetupStruct.html#a20b94e0080d670cfd371b622838f24a7" title="Byte 2 and 3 of setup packet.">wValue</a> == FALSE) || (usbSetup-&gt;<a class="code" href="structCSL__UsbSetupStruct.html#a20b94e0080d670cfd371b622838f24a7" title="Byte 2 and 3 of setup packet.">wValue</a> == TRUE))
<a name="l01324"></a>01324     {
<a name="l01325"></a>01325         pCtrlHandle-&gt;<a class="code" href="structCSL__MscCtrlObject.html#a51b2e21a4e3d3f0c43ae891fa07742f0" title="Current Device Configuration Status.">curConfigStat</a> = usbSetup-&gt;<a class="code" href="structCSL__UsbSetupStruct.html#a20b94e0080d670cfd371b622838f24a7" title="Byte 2 and 3 of setup packet.">wValue</a>;
<a name="l01326"></a>01326 
<a name="l01327"></a>01327         <a class="code" href="group__CSL__USB__FUNCTION.html#ga2afe1be9825d404c775e8570b85338c2">USB_setConfiguration</a>(pMscClassHdl-&gt;<a class="code" href="structCSL__MscClassStruct.html#a4384174b490e63a3d8f1a0d911476b41" title="Handle to the selected USB Device instance.">usbDevHandle</a>, usbSetup-&gt;<a class="code" href="structCSL__UsbSetupStruct.html#a20b94e0080d670cfd371b622838f24a7" title="Byte 2 and 3 of setup packet.">wValue</a>);
<a name="l01328"></a>01328 
<a name="l01329"></a>01329         retStat   = CSL_MSC_REQUEST_SEND_ACK;
<a name="l01330"></a>01330     }
<a name="l01331"></a>01331     <span class="keywordflow">else</span>
<a name="l01332"></a>01332     {
<a name="l01333"></a>01333         <span class="comment">/* configuration not supported, STALL the endpoint */</span>
<a name="l01334"></a>01334         retStat = CSL_MSC_REQUEST_STALL;
<a name="l01335"></a>01335     }
<a name="l01336"></a>01336 
<a name="l01337"></a>01337     <span class="keywordflow">return</span>(retStat);
<a name="l01338"></a>01338 }
<a name="l01339"></a>01339 
<a name="l01394"></a>01394 <span class="keyword">static</span> <span class="keyword">inline</span>
<a name="l01395"></a><a class="code" href="group__CSL__MSC__FUNCTION.html#gadda22cfca94fe72f4b0f72794512ec55">01395</a> <a class="code" href="group__CSL__MSC__ENUM.html#ga9324e3a9461945d734f76af9753281c1" title="This Enum defines the Msc request return values.">CSL_MscRequestRet</a> <a class="code" href="group__CSL__MSC__FUNCTION.html#gadda22cfca94fe72f4b0f72794512ec55">MSC_reqClearFeature</a>(<a class="code" href="structCSL__UsbContext.html" title="USB context information structure.">CSL_UsbDevHandle</a>      devHandle,
<a name="l01396"></a>01396                                       <a class="code" href="structCSL__UsbSetupStruct.html" title="Data structure to hold USB setup packet.">CSL_UsbSetupStruct</a>    *usbSetup,
<a name="l01397"></a>01397                                       <a class="code" href="structCSL__UsbEpObj.html" title="Data Structure for USB Endpoint Object.">CSL_UsbEpHandle</a>       hInEp,
<a name="l01398"></a>01398                                       <a class="code" href="structCSL__UsbEpObj.html" title="Data Structure for USB Endpoint Object.">CSL_UsbEpHandle</a>       hOutEp,
<a name="l01399"></a>01399                                       <span class="keywordtype">void</span>                  *pMsc)
<a name="l01400"></a>01400 {
<a name="l01401"></a>01401     <a class="code" href="group__CSL__MSC__ENUM.html#ga9324e3a9461945d734f76af9753281c1" title="This Enum defines the Msc request return values.">CSL_MscRequestRet</a>    retStat;
<a name="l01402"></a>01402     <a class="code" href="structCSL__UsbEpObj.html" title="Data Structure for USB Endpoint Object.">CSL_UsbEpHandle</a>      hEPx;
<a name="l01403"></a>01403     Uint16               endpt;  <span class="comment">/* this is USB logical endpoint */</span>
<a name="l01404"></a>01404 
<a name="l01405"></a>01405     retStat = CSL_MSC_REQUEST_SEND_ACK;
<a name="l01406"></a>01406 
<a name="l01407"></a>01407     <span class="keywordflow">switch</span>(usbSetup-&gt;<a class="code" href="structCSL__UsbSetupStruct.html#a20b94e0080d670cfd371b622838f24a7" title="Byte 2 and 3 of setup packet.">wValue</a>)
<a name="l01408"></a>01408     {
<a name="l01409"></a>01409         <span class="keywordflow">case</span> <a class="code" href="group__CSL__USB__SYMBOL.html#ga27953368972bacf018d289d44dc0198a" title="USB End point Stall Feature.">CSL_USB_FEATURE_ENDPOINT_STALL</a>:
<a name="l01410"></a>01410             endpt = (usbSetup-&gt;<a class="code" href="structCSL__UsbSetupStruct.html#a3dae40396cdd9c4d62e7e1a017d94774" title="Byte 4 and 5 setup packet.">wIndex</a>) &amp; <a class="code" href="group__CSL__MSC__SYMBOL.html#gabdac328f47cf783c8b8a01fff062348f">CSL_MSC_8BIT_MASK</a>;
<a name="l01411"></a>01411             hEPx = <a class="code" href="group__CSL__USB__FUNCTION.html#ga8a8cddf9f5bb46860bcb0177910d438b">USB_epNumToHandle</a>(devHandle, endpt);
<a name="l01412"></a>01412             <a class="code" href="group__CSL__USB__FUNCTION.html#gaa9238a073828f83b3fc474f183d53677">USB_clearEndptStall</a>(hEPx);
<a name="l01413"></a>01413             <span class="keywordflow">break</span>;
<a name="l01414"></a>01414 
<a name="l01415"></a>01415         <span class="keywordflow">case</span> <a class="code" href="group__CSL__USB__SYMBOL.html#ga53ba9c525cb99ee2fef80c60786a69ab" title="USB Remote Wakeup Feature.">CSL_USB_FEATURE_REMOTE_WAKEUP</a>:
<a name="l01416"></a>01416             <a class="code" href="group__CSL__USB__FUNCTION.html#ga697ac4bdefb5d3c8cbd3bcead1e0b23b">USB_setRemoteWakeup</a>(devHandle, (<a class="code" href="group__CSL__USB__ENUM.html#ga5d102397ad06d902df565f3a4ecc2a91" title="This enum defines status return values of USB.">CSL_UsbBoolean</a>)FALSE);
<a name="l01417"></a>01417             <span class="keywordflow">break</span>;
<a name="l01418"></a>01418 
<a name="l01419"></a>01419         <span class="keywordflow">default</span>:
<a name="l01420"></a>01420             <span class="comment">/* Unsupported Feature. STALL the endpoint */</span>
<a name="l01421"></a>01421             retStat = CSL_MSC_REQUEST_STALL;
<a name="l01422"></a>01422             <span class="keywordflow">break</span>;
<a name="l01423"></a>01423     }
<a name="l01424"></a>01424 
<a name="l01425"></a>01425     <span class="keywordflow">return</span>(retStat);
<a name="l01426"></a>01426 }
<a name="l01427"></a>01427 
<a name="l01482"></a>01482 <span class="keyword">static</span> <span class="keyword">inline</span>
<a name="l01483"></a><a class="code" href="group__CSL__MSC__FUNCTION.html#gab25fc52b3701ce63235407366df10eed">01483</a> <a class="code" href="group__CSL__MSC__ENUM.html#ga9324e3a9461945d734f76af9753281c1" title="This Enum defines the Msc request return values.">CSL_MscRequestRet</a> <a class="code" href="group__CSL__MSC__FUNCTION.html#gab25fc52b3701ce63235407366df10eed">MSC_reqGetStatus</a>(<a class="code" href="structCSL__UsbContext.html" title="USB context information structure.">CSL_UsbDevHandle</a>      devHandle,
<a name="l01484"></a>01484                                    <a class="code" href="structCSL__UsbSetupStruct.html" title="Data structure to hold USB setup packet.">CSL_UsbSetupStruct</a>    *usbSetup,
<a name="l01485"></a>01485                                    <a class="code" href="structCSL__UsbEpObj.html" title="Data Structure for USB Endpoint Object.">CSL_UsbEpHandle</a>       hInEp,
<a name="l01486"></a>01486                                    <a class="code" href="structCSL__UsbEpObj.html" title="Data Structure for USB Endpoint Object.">CSL_UsbEpHandle</a>       hOutEp,
<a name="l01487"></a>01487                                    <span class="keywordtype">void</span>                  *pMsc)
<a name="l01488"></a>01488 {
<a name="l01489"></a>01489     <a class="code" href="group__CSL__MSC__ENUM.html#ga9324e3a9461945d734f76af9753281c1" title="This Enum defines the Msc request return values.">CSL_MscRequestRet</a>     retStat;
<a name="l01490"></a>01490     <a class="code" href="structCSL__MscClassStruct.html" title="MSC Control Object structure.">pMscClassHandle</a>       pMscClassHdl;
<a name="l01491"></a>01491     <a class="code" href="structCSL__MscCtrlObject.html" title="MSC Control Object structure.">CSL_MscCtrlObject</a>     *pCtrlHandle;
<a name="l01492"></a>01492     <a class="code" href="structCSL__UsbEpObj.html" title="Data Structure for USB Endpoint Object.">CSL_UsbEpHandle</a>       hEPx;
<a name="l01493"></a>01493     CSL_Status            status;
<a name="l01494"></a>01494     Uint16                endpt;   <span class="comment">/* this is USB logical endpoint */</span>
<a name="l01495"></a>01495 
<a name="l01496"></a>01496     pMscClassHdl = (<a class="code" href="group__CSL__MSC__DATASTRUCT.html#ga097887623ed20e9e67aa07e992a90d94" title="MSc class handle.">pMscClassHandle</a>)(pMsc);
<a name="l01497"></a>01497     pCtrlHandle  = &amp;pMscClassHdl-&gt;<a class="code" href="structCSL__MscClassStruct.html#a671312a4c84719cc8f327db5f02e7a05" title="Handle to Control Object.">ctrlHandle</a>;
<a name="l01498"></a>01498     retStat      = CSL_MSC_REQUEST_GET_ACK;
<a name="l01499"></a>01499 
<a name="l01500"></a>01500     <span class="keywordflow">switch</span>(usbSetup-&gt;<a class="code" href="structCSL__UsbSetupStruct.html#a78d44b3f43dbe57fe6e94c4c8014cbf3" title="Byte 0 of setup packet.">bmRequestType</a> - <a class="code" href="group__CSL__MSC__SYMBOL.html#ga517cf9fc66612012ebe2b1f260c3a3a2">CSL_MSC_REQUEST_TYPE_BASE</a>)
<a name="l01501"></a>01501     {
<a name="l01502"></a>01502         <span class="comment">/* Device Status to be returned */</span>
<a name="l01503"></a>01503         <span class="keywordflow">case</span> <a class="code" href="group__CSL__MSC__SYMBOL.html#gaf52efdc3cc9371d617e76df9063d0649">CSL_MSC_REQUEST_TYPE_DEVICE_STATUS</a>:
<a name="l01504"></a>01504             pCtrlHandle-&gt;<a class="code" href="structCSL__MscCtrlObject.html#a7325ced3906575c804d6b47fbdca2dc4" title="Array used for General Purpose.">ctrlBuffer</a>[1] =
<a name="l01505"></a>01505             (((Uint16)<a class="code" href="group__CSL__USB__FUNCTION.html#ga3a1737f1a1f76b2cd16120376ba777a1">USB_getRemoteWakeupStat</a>(devHandle))&lt;&lt;1) |
<a name="l01506"></a>01506              <a class="code" href="group__CSL__MSC__SYMBOL.html#ga20a3bd331c7045c29660151114b8b9a1">CSL_MSC_CURRDEV_STAT</a>;
<a name="l01507"></a>01507             <a class="code" href="group__CSL__USB__FUNCTION.html#ga0976835f84a5fedd800c643e6c86703e">USB_postTransaction</a>(hInEp, 2, &amp;pCtrlHandle-&gt;<a class="code" href="structCSL__MscCtrlObject.html#a7325ced3906575c804d6b47fbdca2dc4" title="Array used for General Purpose.">ctrlBuffer</a>,
<a name="l01508"></a>01508                                 <a class="code" href="group__CSL__USB__SYMBOL.html#ga7bd2d646e37049bcdf340f27ca927e29" title="USB IO Flags.">CSL_USB_IOFLAG_NONE</a>);
<a name="l01509"></a>01509             <span class="keywordflow">break</span>;
<a name="l01510"></a>01510 
<a name="l01511"></a>01511         <span class="comment">/* Interface status is to be returned */</span>
<a name="l01512"></a>01512         <span class="keywordflow">case</span> <a class="code" href="group__CSL__MSC__SYMBOL.html#ga593e35c047672dd1edbe4d41238e901c">CSL_MSC_REQUEST_TYPE_INTERFACE_STATUS</a>:
<a name="l01513"></a>01513             pCtrlHandle-&gt;<a class="code" href="structCSL__MscCtrlObject.html#a7325ced3906575c804d6b47fbdca2dc4" title="Array used for General Purpose.">ctrlBuffer</a>[1] = <a class="code" href="group__CSL__MSC__SYMBOL.html#ga20a3bd331c7045c29660151114b8b9a1">CSL_MSC_CURRDEV_STAT</a>;
<a name="l01514"></a>01514             <a class="code" href="group__CSL__USB__FUNCTION.html#ga0976835f84a5fedd800c643e6c86703e">USB_postTransaction</a>(hInEp, 2, &amp;pCtrlHandle-&gt;<a class="code" href="structCSL__MscCtrlObject.html#a7325ced3906575c804d6b47fbdca2dc4" title="Array used for General Purpose.">ctrlBuffer</a>,
<a name="l01515"></a>01515                                 <a class="code" href="group__CSL__USB__SYMBOL.html#ga7bd2d646e37049bcdf340f27ca927e29" title="USB IO Flags.">CSL_USB_IOFLAG_NONE</a>);
<a name="l01516"></a>01516             <span class="keywordflow">break</span>;
<a name="l01517"></a>01517 
<a name="l01518"></a>01518         <span class="comment">/* Endpoint status to be returned */</span>
<a name="l01519"></a>01519         <span class="keywordflow">case</span> <a class="code" href="group__CSL__MSC__SYMBOL.html#ga5ed992b9c52bae04331c813a9cabfc12">CSL_MSC_REQUEST_TYPE_EP_STATUS</a>:
<a name="l01520"></a>01520 
<a name="l01521"></a>01521             endpt  =  usbSetup-&gt;<a class="code" href="structCSL__UsbSetupStruct.html#a3dae40396cdd9c4d62e7e1a017d94774" title="Byte 4 and 5 setup packet.">wIndex</a> &amp; 0xFF;
<a name="l01522"></a>01522             hEPx   =  <a class="code" href="group__CSL__USB__FUNCTION.html#ga8a8cddf9f5bb46860bcb0177910d438b">USB_epNumToHandle</a>(pMscClassHdl-&gt;<a class="code" href="structCSL__MscClassStruct.html#a4384174b490e63a3d8f1a0d911476b41" title="Handle to the selected USB Device instance.">usbDevHandle</a>, endpt);
<a name="l01523"></a>01523             pCtrlHandle-&gt;<a class="code" href="structCSL__MscCtrlObject.html#a7325ced3906575c804d6b47fbdca2dc4" title="Array used for General Purpose.">ctrlBuffer</a>[1] = (Uint16)<a class="code" href="group__CSL__USB__FUNCTION.html#gadad6e2731853b7b0edeb2fd65dc24fd0">USB_getEndptStall</a>(hEPx,
<a name="l01524"></a>01524                                                                    &amp;status);
<a name="l01525"></a>01525             <a class="code" href="group__CSL__USB__FUNCTION.html#ga0976835f84a5fedd800c643e6c86703e">USB_postTransaction</a>(hInEp, 2, &amp;pCtrlHandle-&gt;<a class="code" href="structCSL__MscCtrlObject.html#a7325ced3906575c804d6b47fbdca2dc4" title="Array used for General Purpose.">ctrlBuffer</a>,
<a name="l01526"></a>01526                                 <a class="code" href="group__CSL__USB__SYMBOL.html#ga7bd2d646e37049bcdf340f27ca927e29" title="USB IO Flags.">CSL_USB_IOFLAG_NONE</a>);
<a name="l01527"></a>01527             <span class="keywordflow">break</span>;
<a name="l01528"></a>01528 
<a name="l01529"></a>01529         <span class="keywordflow">default</span>:
<a name="l01530"></a>01530             <span class="comment">/* STALL the endpoint */</span>
<a name="l01531"></a>01531             retStat = CSL_MSC_REQUEST_STALL;
<a name="l01532"></a>01532             <span class="keywordflow">break</span>;
<a name="l01533"></a>01533     }
<a name="l01534"></a>01534 
<a name="l01535"></a>01535     <span class="keywordflow">return</span>(retStat);
<a name="l01536"></a>01536 }
<a name="l01537"></a>01537 
<a name="l01592"></a>01592 <span class="keyword">static</span> <span class="keyword">inline</span>
<a name="l01593"></a><a class="code" href="group__CSL__MSC__FUNCTION.html#ga36d52d670751ab36289b5b9c5eda7578">01593</a> <a class="code" href="group__CSL__MSC__ENUM.html#ga9324e3a9461945d734f76af9753281c1" title="This Enum defines the Msc request return values.">CSL_MscRequestRet</a> <a class="code" href="group__CSL__MSC__FUNCTION.html#ga36d52d670751ab36289b5b9c5eda7578">MSC_reqSetFeature</a>(<a class="code" href="structCSL__UsbContext.html" title="USB context information structure.">CSL_UsbDevHandle</a>      devHandle,
<a name="l01594"></a>01594                                     <a class="code" href="structCSL__UsbSetupStruct.html" title="Data structure to hold USB setup packet.">CSL_UsbSetupStruct</a>    *usbSetup,
<a name="l01595"></a>01595                                     <a class="code" href="structCSL__UsbEpObj.html" title="Data Structure for USB Endpoint Object.">CSL_UsbEpHandle</a>       hInEp,
<a name="l01596"></a>01596                                     <a class="code" href="structCSL__UsbEpObj.html" title="Data Structure for USB Endpoint Object.">CSL_UsbEpHandle</a>       hOutEp,
<a name="l01597"></a>01597                                     <span class="keywordtype">void</span>                  *pMsc)
<a name="l01598"></a>01598 {
<a name="l01599"></a>01599     <a class="code" href="group__CSL__MSC__ENUM.html#ga9324e3a9461945d734f76af9753281c1" title="This Enum defines the Msc request return values.">CSL_MscRequestRet</a>    retStat;
<a name="l01600"></a>01600     <a class="code" href="structCSL__UsbEpObj.html" title="Data Structure for USB Endpoint Object.">CSL_UsbEpHandle</a>      hEPx;
<a name="l01601"></a>01601     Uint16               endpt;        <span class="comment">/* this is USB logical endpoint */</span>
<a name="l01602"></a>01602 
<a name="l01603"></a>01603     retStat = CSL_MSC_REQUEST_SEND_ACK;
<a name="l01604"></a>01604 
<a name="l01605"></a>01605     <span class="keywordflow">switch</span>(usbSetup-&gt;<a class="code" href="structCSL__UsbSetupStruct.html#a20b94e0080d670cfd371b622838f24a7" title="Byte 2 and 3 of setup packet.">wValue</a>)
<a name="l01606"></a>01606     {
<a name="l01607"></a>01607         <span class="keywordflow">case</span> <a class="code" href="group__CSL__USB__SYMBOL.html#ga27953368972bacf018d289d44dc0198a" title="USB End point Stall Feature.">CSL_USB_FEATURE_ENDPOINT_STALL</a>:
<a name="l01608"></a>01608             <span class="comment">/* updated set and clear endpoint stall to work with logical endpoint num */</span>
<a name="l01609"></a>01609             endpt = (usbSetup-&gt;<a class="code" href="structCSL__UsbSetupStruct.html#a3dae40396cdd9c4d62e7e1a017d94774" title="Byte 4 and 5 setup packet.">wIndex</a>) &amp; <a class="code" href="group__CSL__MSC__SYMBOL.html#gabdac328f47cf783c8b8a01fff062348f">CSL_MSC_8BIT_MASK</a>;
<a name="l01610"></a>01610             hEPx = <a class="code" href="group__CSL__USB__FUNCTION.html#ga8a8cddf9f5bb46860bcb0177910d438b">USB_epNumToHandle</a>(devHandle, endpt);
<a name="l01611"></a>01611             <a class="code" href="group__CSL__USB__FUNCTION.html#gaa1befea5ae93ae7079e52df923a54c21">USB_stallEndpt</a>(hEPx);
<a name="l01612"></a>01612             <span class="keywordflow">break</span>;
<a name="l01613"></a>01613 
<a name="l01614"></a>01614         <span class="keywordflow">case</span> <a class="code" href="group__CSL__USB__SYMBOL.html#ga53ba9c525cb99ee2fef80c60786a69ab" title="USB Remote Wakeup Feature.">CSL_USB_FEATURE_REMOTE_WAKEUP</a>:
<a name="l01615"></a>01615             <a class="code" href="group__CSL__USB__FUNCTION.html#ga697ac4bdefb5d3c8cbd3bcead1e0b23b">USB_setRemoteWakeup</a>(devHandle, (<a class="code" href="group__CSL__USB__ENUM.html#ga5d102397ad06d902df565f3a4ecc2a91" title="This enum defines status return values of USB.">CSL_UsbBoolean</a>)TRUE);
<a name="l01616"></a>01616             <span class="keywordflow">break</span>;
<a name="l01617"></a>01617 
<a name="l01618"></a>01618         <span class="keywordflow">default</span>:
<a name="l01619"></a>01619             <span class="comment">/* Feature not supported, STALL the endpoint */</span>
<a name="l01620"></a>01620             retStat = CSL_MSC_REQUEST_STALL;
<a name="l01621"></a>01621             <span class="keywordflow">break</span>;
<a name="l01622"></a>01622     }
<a name="l01623"></a>01623 
<a name="l01624"></a>01624   <span class="keywordflow">return</span>(retStat);
<a name="l01625"></a>01625 }
<a name="l01626"></a>01626 
<a name="l01680"></a>01680 <span class="keyword">static</span> <span class="keyword">inline</span>
<a name="l01681"></a><a class="code" href="group__CSL__MSC__FUNCTION.html#ga519d935865a17bd4dac66e03863b7cce">01681</a> <a class="code" href="group__CSL__MSC__ENUM.html#ga9324e3a9461945d734f76af9753281c1" title="This Enum defines the Msc request return values.">CSL_MscRequestRet</a> <a class="code" href="group__CSL__MSC__FUNCTION.html#ga519d935865a17bd4dac66e03863b7cce">MSC_reqGetConfiguration</a>(<a class="code" href="structCSL__UsbContext.html" title="USB context information structure.">CSL_UsbDevHandle</a>      devHandle,
<a name="l01682"></a>01682                                           <a class="code" href="structCSL__UsbSetupStruct.html" title="Data structure to hold USB setup packet.">CSL_UsbSetupStruct</a>    *usbSetup,
<a name="l01683"></a>01683                                           <a class="code" href="structCSL__UsbEpObj.html" title="Data Structure for USB Endpoint Object.">CSL_UsbEpHandle</a>       hInEp,
<a name="l01684"></a>01684                                           <a class="code" href="structCSL__UsbEpObj.html" title="Data Structure for USB Endpoint Object.">CSL_UsbEpHandle</a>       hOutEp,
<a name="l01685"></a>01685                                           <span class="keywordtype">void</span>                  *pMsc)
<a name="l01686"></a>01686 {
<a name="l01687"></a>01687     <a class="code" href="structCSL__MscClassStruct.html" title="MSC Control Object structure.">pMscClassHandle</a>       pMscClassHdl;
<a name="l01688"></a>01688     <a class="code" href="structCSL__MscCtrlObject.html" title="MSC Control Object structure.">CSL_MscCtrlObject</a>*    pCtrlHandle;
<a name="l01689"></a>01689 
<a name="l01690"></a>01690     pMscClassHdl = (<a class="code" href="group__CSL__MSC__DATASTRUCT.html#ga097887623ed20e9e67aa07e992a90d94" title="MSc class handle.">pMscClassHandle</a>)(pMsc);
<a name="l01691"></a>01691     pCtrlHandle  = &amp;pMscClassHdl-&gt;<a class="code" href="structCSL__MscClassStruct.html#a671312a4c84719cc8f327db5f02e7a05" title="Handle to Control Object.">ctrlHandle</a>;
<a name="l01692"></a>01692 
<a name="l01693"></a>01693     <span class="comment">/* Send the current Configuration Value */</span>
<a name="l01694"></a>01694     pCtrlHandle-&gt;<a class="code" href="structCSL__MscCtrlObject.html#a7325ced3906575c804d6b47fbdca2dc4" title="Array used for General Purpose.">ctrlBuffer</a>[1] = pCtrlHandle-&gt;<a class="code" href="structCSL__MscCtrlObject.html#a51b2e21a4e3d3f0c43ae891fa07742f0" title="Current Device Configuration Status.">curConfigStat</a>;
<a name="l01695"></a>01695     <a class="code" href="group__CSL__USB__FUNCTION.html#ga0976835f84a5fedd800c643e6c86703e">USB_postTransaction</a>(hInEp, 1, (<span class="keywordtype">void</span>*)&amp;pCtrlHandle-&gt;<a class="code" href="structCSL__MscCtrlObject.html#a7325ced3906575c804d6b47fbdca2dc4" title="Array used for General Purpose.">ctrlBuffer</a>,
<a name="l01696"></a>01696                         <a class="code" href="group__CSL__USB__SYMBOL.html#ga7bd2d646e37049bcdf340f27ca927e29" title="USB IO Flags.">CSL_USB_IOFLAG_NONE</a> | <a class="code" href="group__CSL__USB__SYMBOL.html#ga8874c47ae40bc99a01424c1577538a25">CSL_USB_IOFLAG_NOSHORT</a>);
<a name="l01697"></a>01697 
<a name="l01698"></a>01698     <span class="keywordflow">return</span>(CSL_MSC_REQUEST_GET_ACK);
<a name="l01699"></a>01699 }
<a name="l01700"></a>01700 
<a name="l01756"></a>01756 <span class="keyword">static</span> <span class="keyword">inline</span>
<a name="l01757"></a><a class="code" href="group__CSL__MSC__FUNCTION.html#gad3d5e95f491870fd5bebb7cd108db6a9">01757</a> <a class="code" href="group__CSL__MSC__ENUM.html#ga9324e3a9461945d734f76af9753281c1" title="This Enum defines the Msc request return values.">CSL_MscRequestRet</a> <a class="code" href="group__CSL__MSC__FUNCTION.html#gad3d5e95f491870fd5bebb7cd108db6a9">MSC_reqGetMaxLUN</a>(<a class="code" href="structCSL__UsbContext.html" title="USB context information structure.">CSL_UsbDevHandle</a>      devHandle,
<a name="l01758"></a>01758                                    <a class="code" href="structCSL__UsbSetupStruct.html" title="Data structure to hold USB setup packet.">CSL_UsbSetupStruct</a>    *usbSetup,
<a name="l01759"></a>01759                                    <a class="code" href="structCSL__UsbEpObj.html" title="Data Structure for USB Endpoint Object.">CSL_UsbEpHandle</a>       hInEp,
<a name="l01760"></a>01760                                    <a class="code" href="structCSL__UsbEpObj.html" title="Data Structure for USB Endpoint Object.">CSL_UsbEpHandle</a>       hOutEp,
<a name="l01761"></a>01761                                    <span class="keywordtype">void</span>                  *pMsc)
<a name="l01762"></a>01762 {
<a name="l01763"></a>01763     <a class="code" href="structCSL__MscClassStruct.html" title="MSC Control Object structure.">pMscClassHandle</a>       pMscClassHdl;
<a name="l01764"></a>01764     <a class="code" href="structCSL__MscCtrlObject.html" title="MSC Control Object structure.">CSL_MscCtrlObject</a>*    pCtrlHandle;
<a name="l01765"></a>01765     <a class="code" href="group__CSL__MSC__ENUM.html#ga9324e3a9461945d734f76af9753281c1" title="This Enum defines the Msc request return values.">CSL_MscRequestRet</a>     retStat;
<a name="l01766"></a>01766 
<a name="l01767"></a>01767     pMscClassHdl = (<a class="code" href="group__CSL__MSC__DATASTRUCT.html#ga097887623ed20e9e67aa07e992a90d94" title="MSc class handle.">pMscClassHandle</a>)(pMsc);
<a name="l01768"></a>01768     pCtrlHandle  = &amp;pMscClassHdl-&gt;<a class="code" href="structCSL__MscClassStruct.html#a671312a4c84719cc8f327db5f02e7a05" title="Handle to Control Object.">ctrlHandle</a>;
<a name="l01769"></a>01769     pCtrlHandle-&gt;<a class="code" href="structCSL__MscCtrlObject.html#a7325ced3906575c804d6b47fbdca2dc4" title="Array used for General Purpose.">ctrlBuffer</a>[1] = pMscClassHdl-&gt;<a class="code" href="structCSL__MscClassStruct.html#a546161ca6a02e6dd7504b5ef6d5cfb4a" title="Handle to Bulk Transfer Object.">mscHandle</a>.<a class="code" href="structCSL__MscObject.html#a7152cbef58dca1ae265aff0b52b83485" title="Maximum No.of Logical Units.">noOfLun</a>;
<a name="l01770"></a>01770 
<a name="l01771"></a>01771     <span class="comment">/*</span>
<a name="l01772"></a>01772 <span class="comment">     * Verify the setup packet fields</span>
<a name="l01773"></a>01773 <span class="comment">     * wValue - 0</span>
<a name="l01774"></a>01774 <span class="comment">     * wIndex - interface number, set 0</span>
<a name="l01775"></a>01775 <span class="comment">     * wLength - 1</span>
<a name="l01776"></a>01776 <span class="comment">     */</span>
<a name="l01777"></a>01777     <span class="keywordflow">if</span> ((usbSetup-&gt;<a class="code" href="structCSL__UsbSetupStruct.html#a3dae40396cdd9c4d62e7e1a017d94774" title="Byte 4 and 5 setup packet.">wIndex</a> == 0) &amp;&amp;
<a name="l01778"></a>01778         (usbSetup-&gt;<a class="code" href="structCSL__UsbSetupStruct.html#a99f4f2c530e96b3b48fcfe75d63f3d72" title="Byte 6 and 7 of setup packet.">wLength</a> == 1) &amp;&amp;
<a name="l01779"></a>01779         (usbSetup-&gt;<a class="code" href="structCSL__UsbSetupStruct.html#a20b94e0080d670cfd371b622838f24a7" title="Byte 2 and 3 of setup packet.">wValue</a> == 0))
<a name="l01780"></a>01780     {
<a name="l01781"></a>01781         <a class="code" href="group__CSL__USB__FUNCTION.html#ga0976835f84a5fedd800c643e6c86703e">USB_postTransaction</a>(hInEp, 1, &amp;pCtrlHandle-&gt;<a class="code" href="structCSL__MscCtrlObject.html#a7325ced3906575c804d6b47fbdca2dc4" title="Array used for General Purpose.">ctrlBuffer</a>[0],
<a name="l01782"></a>01782                             <a class="code" href="group__CSL__USB__SYMBOL.html#ga7bd2d646e37049bcdf340f27ca927e29" title="USB IO Flags.">CSL_USB_IOFLAG_NONE</a>);
<a name="l01783"></a>01783 
<a name="l01784"></a>01784         <span class="comment">/* Receive a 0 length packet for acknowledgement */</span>
<a name="l01785"></a>01785         retStat = CSL_MSC_REQUEST_GET_ACK;
<a name="l01786"></a>01786     }
<a name="l01787"></a>01787     <span class="keywordflow">else</span>
<a name="l01788"></a>01788     {
<a name="l01789"></a>01789         retStat = CSL_MSC_REQUEST_STALL;
<a name="l01790"></a>01790     }
<a name="l01791"></a>01791 
<a name="l01792"></a>01792     <span class="keywordflow">return</span> (retStat);
<a name="l01793"></a>01793 }
<a name="l01794"></a>01794 
<a name="l01850"></a>01850 <span class="keyword">static</span> <span class="keyword">inline</span>
<a name="l01851"></a><a class="code" href="group__CSL__MSC__FUNCTION.html#gae342552f1b4fd3c27ead654215d7cad1">01851</a> <a class="code" href="group__CSL__MSC__ENUM.html#ga9324e3a9461945d734f76af9753281c1" title="This Enum defines the Msc request return values.">CSL_MscRequestRet</a> <a class="code" href="group__CSL__MSC__FUNCTION.html#gae342552f1b4fd3c27ead654215d7cad1">MSC_reqGetInterface</a>(<a class="code" href="structCSL__UsbContext.html" title="USB context information structure.">CSL_UsbDevHandle</a>      devHandle,
<a name="l01852"></a>01852                                       <a class="code" href="structCSL__UsbSetupStruct.html" title="Data structure to hold USB setup packet.">CSL_UsbSetupStruct</a>    *usbSetup,
<a name="l01853"></a>01853                                       <a class="code" href="structCSL__UsbEpObj.html" title="Data Structure for USB Endpoint Object.">CSL_UsbEpHandle</a>       hInEp,
<a name="l01854"></a>01854                                       <a class="code" href="structCSL__UsbEpObj.html" title="Data Structure for USB Endpoint Object.">CSL_UsbEpHandle</a>       hOutEp,
<a name="l01855"></a>01855                                       <span class="keywordtype">void</span>                  *pMsc)
<a name="l01856"></a>01856 {
<a name="l01857"></a>01857     <a class="code" href="structCSL__MscClassStruct.html" title="MSC Control Object structure.">pMscClassHandle</a>       pMscClassHdl;
<a name="l01858"></a>01858     <a class="code" href="structCSL__MscCtrlObject.html" title="MSC Control Object structure.">CSL_MscCtrlObject</a>     *pCtrlHandle;
<a name="l01859"></a>01859     <a class="code" href="group__CSL__MSC__ENUM.html#ga9324e3a9461945d734f76af9753281c1" title="This Enum defines the Msc request return values.">CSL_MscRequestRet</a>     retStat;
<a name="l01860"></a>01860 
<a name="l01861"></a>01861     pMscClassHdl = (<a class="code" href="group__CSL__MSC__DATASTRUCT.html#ga097887623ed20e9e67aa07e992a90d94" title="MSc class handle.">pMscClassHandle</a>)(pMsc);
<a name="l01862"></a>01862     pCtrlHandle  = &amp;pMscClassHdl-&gt;<a class="code" href="structCSL__MscClassStruct.html#a671312a4c84719cc8f327db5f02e7a05" title="Handle to Control Object.">ctrlHandle</a>;
<a name="l01863"></a>01863     retStat      = CSL_MSC_REQUEST_GET_ACK;
<a name="l01864"></a>01864 
<a name="l01865"></a>01865     <span class="comment">/* Compare the Interface with the bNumInterfaces byte of Configuration Descriptor */</span>
<a name="l01866"></a>01866     <span class="keywordflow">if</span>(usbSetup-&gt;<a class="code" href="structCSL__UsbSetupStruct.html#a3dae40396cdd9c4d62e7e1a017d94774" title="Byte 4 and 5 setup packet.">wIndex</a> == 0)
<a name="l01867"></a>01867     {
<a name="l01868"></a>01868         <span class="comment">/* Send the current Interface Value */</span>
<a name="l01869"></a>01869         pCtrlHandle-&gt;<a class="code" href="structCSL__MscCtrlObject.html#a7325ced3906575c804d6b47fbdca2dc4" title="Array used for General Purpose.">ctrlBuffer</a>[1] = 0;
<a name="l01870"></a>01870         <a class="code" href="group__CSL__USB__FUNCTION.html#ga0976835f84a5fedd800c643e6c86703e">USB_postTransaction</a>(hInEp, 1, &amp;pCtrlHandle-&gt;<a class="code" href="structCSL__MscCtrlObject.html#a7325ced3906575c804d6b47fbdca2dc4" title="Array used for General Purpose.">ctrlBuffer</a>[0],
<a name="l01871"></a>01871                             <a class="code" href="group__CSL__USB__SYMBOL.html#ga7bd2d646e37049bcdf340f27ca927e29" title="USB IO Flags.">CSL_USB_IOFLAG_NONE</a>);
<a name="l01872"></a>01872     }
<a name="l01873"></a>01873     <span class="keywordflow">else</span>
<a name="l01874"></a>01874     {
<a name="l01875"></a>01875         <span class="comment">/*  Interface specified doesn&#39;t exist, STALL the endpoint */</span>
<a name="l01876"></a>01876         retStat = CSL_MSC_REQUEST_STALL;
<a name="l01877"></a>01877     }
<a name="l01878"></a>01878 
<a name="l01879"></a>01879     <span class="keywordflow">return</span> retStat;
<a name="l01880"></a>01880 }
<a name="l01881"></a>01881 
<a name="l01937"></a>01937 <span class="keyword">static</span> <span class="keyword">inline</span>
<a name="l01938"></a><a class="code" href="group__CSL__MSC__FUNCTION.html#gad4df068abe8eb407fa944791ab9120e0">01938</a> <a class="code" href="group__CSL__MSC__ENUM.html#ga9324e3a9461945d734f76af9753281c1" title="This Enum defines the Msc request return values.">CSL_MscRequestRet</a> <a class="code" href="group__CSL__MSC__FUNCTION.html#gad4df068abe8eb407fa944791ab9120e0">MSC_reqSetInterface</a>(<a class="code" href="structCSL__UsbContext.html" title="USB context information structure.">CSL_UsbDevHandle</a>      devHandle,
<a name="l01939"></a>01939                                       <a class="code" href="structCSL__UsbSetupStruct.html" title="Data structure to hold USB setup packet.">CSL_UsbSetupStruct</a>    *usbSetup,
<a name="l01940"></a>01940                                       <a class="code" href="structCSL__UsbEpObj.html" title="Data Structure for USB Endpoint Object.">CSL_UsbEpHandle</a>       hInEp,
<a name="l01941"></a>01941                                       <a class="code" href="structCSL__UsbEpObj.html" title="Data Structure for USB Endpoint Object.">CSL_UsbEpHandle</a>       hOutEp,
<a name="l01942"></a>01942                                       <span class="keywordtype">void</span>                  *pMsc)
<a name="l01943"></a>01943 {
<a name="l01944"></a>01944     <a class="code" href="group__CSL__MSC__ENUM.html#ga9324e3a9461945d734f76af9753281c1" title="This Enum defines the Msc request return values.">CSL_MscRequestRet</a>    retStat;
<a name="l01945"></a>01945 
<a name="l01946"></a>01946     <span class="keywordflow">if</span>(usbSetup-&gt;<a class="code" href="structCSL__UsbSetupStruct.html#a3dae40396cdd9c4d62e7e1a017d94774" title="Byte 4 and 5 setup packet.">wIndex</a> == 0)
<a name="l01947"></a>01947     {
<a name="l01948"></a>01948         <span class="keywordflow">if</span> (usbSetup-&gt;<a class="code" href="structCSL__UsbSetupStruct.html#a20b94e0080d670cfd371b622838f24a7" title="Byte 2 and 3 of setup packet.">wValue</a> == 0)
<a name="l01949"></a>01949         {
<a name="l01950"></a>01950             <a class="code" href="group__CSL__USB__FUNCTION.html#ga2afe1be9825d404c775e8570b85338c2">USB_setConfiguration</a>(devHandle,usbSetup-&gt;<a class="code" href="structCSL__UsbSetupStruct.html#a20b94e0080d670cfd371b622838f24a7" title="Byte 2 and 3 of setup packet.">wValue</a>);
<a name="l01951"></a>01951             retStat = CSL_MSC_REQUEST_SEND_ACK;
<a name="l01952"></a>01952         }
<a name="l01953"></a>01953     }
<a name="l01954"></a>01954     <span class="keywordflow">else</span>
<a name="l01955"></a>01955     {
<a name="l01956"></a>01956         <span class="comment">/* configuration not supported, STALL the endpoint */</span>
<a name="l01957"></a>01957         retStat = CSL_MSC_REQUEST_STALL;
<a name="l01958"></a>01958     }
<a name="l01959"></a>01959 
<a name="l01960"></a>01960     <span class="keywordflow">return</span>(retStat);
<a name="l01961"></a>01961 }
<a name="l01962"></a>01962 
<a name="l02012"></a>02012 <span class="keyword">static</span> <span class="keyword">inline</span>
<a name="l02013"></a><a class="code" href="group__CSL__MSC__FUNCTION.html#ga326bb71633b4d09620ab0396d0e4457d">02013</a> CSL_Status  <a class="code" href="group__CSL__MSC__FUNCTION.html#ga326bb71633b4d09620ab0396d0e4457d">MSC_verifyCBW</a>(<a class="code" href="structCSL__UsbContext.html" title="USB context information structure.">CSL_UsbDevHandle</a> hUsbDev,
<a name="l02014"></a>02014                           <a class="code" href="structCSL__MscObject.html" title="MSC Mass Storage Object structure.">CSL_MscObject</a>    *pMscHandle,
<a name="l02015"></a>02015                           <a class="code" href="structCSL__UsbEpObj.html" title="Data Structure for USB Endpoint Object.">CSL_UsbEpHandle</a>  hUsbOutEp,
<a name="l02016"></a>02016                           <a class="code" href="structCSL__UsbEpObj.html" title="Data Structure for USB Endpoint Object.">CSL_UsbEpHandle</a>  hUsbInEp)
<a name="l02017"></a>02017 {
<a name="l02018"></a>02018     Uint32        cbwSignature;
<a name="l02019"></a>02019     CSL_Status    status;
<a name="l02020"></a>02020     Uint16        cbwSize;
<a name="l02021"></a>02021     Uint16        logicalUnit;
<a name="l02022"></a>02022 
<a name="l02023"></a>02023     cbwSignature = 0;
<a name="l02024"></a>02024     status       = <a class="code" href="csl__error_8h.html#a8f03a584bbe51a4b3ea2fd16dda762f7">CSL_SOK</a>;
<a name="l02025"></a>02025     cbwSize      = 0;
<a name="l02026"></a>02026     logicalUnit  = 0;
<a name="l02027"></a>02027 
<a name="l02028"></a>02028     <span class="keywordflow">if</span> ((pMscHandle != NULL) &amp;&amp; (hUsbOutEp != NULL) &amp;&amp; (hUsbInEp != NULL))
<a name="l02029"></a>02029     {
<a name="l02030"></a>02030         cbwSignature =  ((Uint32)(pMscHandle-&gt;<a class="code" href="structCSL__MscObject.html#a33a41cf4247cde09062f4c7f7b6814d3" title="Array used to store the elements of CBW.">cbw</a>[<a class="code" href="group__CSL__MSC__SYMBOL.html#ga2b66c7a8626efb92753973274c4c7b83">CSL_MSC_CBW_1</a>]) &lt;&lt;
<a name="l02031"></a>02031                                   <a class="code" href="group__CSL__MSC__SYMBOL.html#ga7ffd8a4483cfb8e4791575e212fa3adb">CSL_MSC_16BIT_SHIFT</a>) |
<a name="l02032"></a>02032                                   (Uint32)pMscHandle-&gt;<a class="code" href="structCSL__MscObject.html#a33a41cf4247cde09062f4c7f7b6814d3" title="Array used to store the elements of CBW.">cbw</a>[<a class="code" href="group__CSL__MSC__SYMBOL.html#ga4a176b08cde8b2947637be7de793bf44" title="USB MSC Command Block Word definitions.">CSL_MSC_CBW_0</a>];
<a name="l02033"></a>02033 
<a name="l02034"></a>02034         <span class="keywordflow">if</span> (cbwSignature != <a class="code" href="group__CSL__MSC__SYMBOL.html#ga428a076ca1d158e6835c7c9a5445bc2e">CSL_MSC_CBW_SIGNATURE</a>)
<a name="l02035"></a>02035         {
<a name="l02036"></a>02036             status = <a class="code" href="csl__error_8h.html#a68f8ee30ab7851128f90554d9139d486">CSL_ESYS_FAIL</a>;
<a name="l02037"></a>02037         }
<a name="l02038"></a>02038         <span class="keywordflow">else</span>
<a name="l02039"></a>02039         {
<a name="l02040"></a>02040             cbwSize = <a class="code" href="group__CSL__USB__FUNCTION.html#gab2fb9c235d6458e544f2ab573605072a">USB_getDataCountReadFromFifo</a>(hUsbOutEp);
<a name="l02041"></a>02041             <span class="keywordflow">if</span> (cbwSize != <a class="code" href="group__CSL__MSC__SYMBOL.html#ga29b8e226727e410109faeab67bf1155e">CSL_MSC_CBW_DATA_SIZE</a>)
<a name="l02042"></a>02042             {
<a name="l02043"></a>02043                 status = <a class="code" href="csl__error_8h.html#a68f8ee30ab7851128f90554d9139d486">CSL_ESYS_FAIL</a>;
<a name="l02044"></a>02044             }
<a name="l02045"></a>02045             <span class="keywordflow">else</span>
<a name="l02046"></a>02046             {
<a name="l02047"></a>02047                 <span class="comment">/* Getting the logical Unit ready */</span>
<a name="l02048"></a>02048                 logicalUnit = pMscHandle-&gt;<a class="code" href="structCSL__MscObject.html#a33a41cf4247cde09062f4c7f7b6814d3" title="Array used to store the elements of CBW.">cbw</a>[<a class="code" href="group__CSL__MSC__SYMBOL.html#gaf7dfe9ecfa4575b0ec4893220879560a">CSL_MSC_CBW_6</a>] &gt;&gt; <a class="code" href="group__CSL__MSC__SYMBOL.html#gac63c387b97d17851047edf275a87ff3f">CSL_MSC_8BIT_SHIFT</a>;
<a name="l02049"></a>02049 
<a name="l02050"></a>02050                 <span class="keywordflow">if</span> (logicalUnit &gt; pMscHandle-&gt;<a class="code" href="structCSL__MscObject.html#a7152cbef58dca1ae265aff0b52b83485" title="Maximum No.of Logical Units.">noOfLun</a>)
<a name="l02051"></a>02051                 {
<a name="l02052"></a>02052                     status = <a class="code" href="csl__error_8h.html#a68f8ee30ab7851128f90554d9139d486">CSL_ESYS_FAIL</a>;
<a name="l02053"></a>02053                 }
<a name="l02054"></a>02054             }
<a name="l02055"></a>02055         }
<a name="l02056"></a>02056     }
<a name="l02057"></a>02057     <span class="keywordflow">else</span>
<a name="l02058"></a>02058     {
<a name="l02059"></a>02059         status = <a class="code" href="csl__error_8h.html#a68f8ee30ab7851128f90554d9139d486">CSL_ESYS_FAIL</a>;
<a name="l02060"></a>02060     }
<a name="l02061"></a>02061 
<a name="l02062"></a>02062     <span class="keywordflow">return</span> (status);
<a name="l02063"></a>02063 }
<a name="l02064"></a>02064 
<a name="l02068"></a>02068 <span class="preprocessor">#ifdef __cplusplus</span>
<a name="l02069"></a>02069 <span class="preprocessor"></span>}
<a name="l02070"></a>02070 <span class="preprocessor">#endif</span>
<a name="l02071"></a>02071 <span class="preprocessor"></span>
<a name="l02072"></a>02072 <span class="preprocessor">#endif    // _CSL_MSCAUX_H_</span>
<a name="l02073"></a>02073 <span class="preprocessor"></span>
</pre></div></div>
</div>
<hr class="footer"/><address class="footer"><small>Generated on Wed Mar 27 2013 13:32:42 for C55XX CSL LP by&#160;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.7.4 </small></address>
</body>
</html>
